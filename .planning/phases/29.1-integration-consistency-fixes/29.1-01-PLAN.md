---
phase: 29.1-integration-consistency-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All imageModel fallbacks consistently use 'nanobanana-pro'"
    - "Shots created from speech segments include emotion data from segment"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Consistent imageModel defaults, emotion inheritance"
      contains: "nanobanana-pro"
  key_links:
    - from: "createShotsFromSpeechSegments()"
      to: "shot array"
      via: "emotion field assignment"
      pattern: "'emotion'.*segment\\['emotion'\\]"
---

<objective>
Fix two tech debt items in VideoWizard.php identified by M11.2 audit:

1. DEBT-01: Update 3 remaining imageModel fallbacks from 'hidream' to 'nanobanana-pro'
2. DEBT-02: Add emotion field to shot creation in createShotsFromSpeechSegments

Purpose: Ensure consistent defaults and complete data inheritance across the wizard
Output: VideoWizard.php with all 6 imageModel fallbacks using 'nanobanana-pro' and emotion data passed through to shots
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update imageModel fallbacks to nanobanana-pro</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Update three remaining 'hidream' fallbacks to 'nanobanana-pro' at these exact locations:

Line 26503 - Multi-shot generation:
```php
// BEFORE:
'model' => $this->storyboard['imageModel'] ?? 'hidream',
// AFTER:
'model' => $this->storyboard['imageModel'] ?? 'nanobanana-pro',
```

Line 26918 - Collage shot generation:
```php
// BEFORE:
'model' => $this->storyboard['imageModel'] ?? 'hidream',
// AFTER:
'model' => $this->storyboard['imageModel'] ?? 'nanobanana-pro',
```

Line 27255 - Second collage generation path:
```php
// BEFORE:
'model' => $this->storyboard['imageModel'] ?? 'hidream',
// AFTER:
'model' => $this->storyboard['imageModel'] ?? 'nanobanana-pro',
```

These are simple string replacements. Do NOT change any other code on these lines.
  </action>
  <verify>
Run: `grep -n "hidream" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
Expected: No results (all 'hidream' references removed)

Run: `grep -c "nanobanana-pro" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
Expected: Count of 6 (3 from Plan 29-01 + 3 new from this task)
  </verify>
  <done>All imageModel fallbacks use 'nanobanana-pro' consistently</done>
</task>

<task type="auto">
  <name>Task 2: Add emotion field to shot creation in createShotsFromSpeechSegments</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
In createShotsFromSpeechSegments() method, add emotion field to shot array creation.

Location: Around line 25244, in the shot array construction

Find this block:
```php
$shot = [
    'id' => uniqid('shot_'),
    'speechSegments' => [$segment], // Single segment per shot
    'needsLipSync' => true,
    'dialogue' => $text,
    'monologue' => $text,
    'speakingCharacter' => $speaker,
    // ... more fields
];
```

Add emotion field after 'monologue' line:
```php
$shot = [
    'id' => uniqid('shot_'),
    'speechSegments' => [$segment], // Single segment per shot
    'needsLipSync' => true,
    'dialogue' => $text,
    'monologue' => $text,
    'emotion' => $segment['emotion'] ?? null,  // ADD THIS LINE
    'speakingCharacter' => $speaker,
    // ... rest unchanged
];
```

This ensures emotion data from speech segments is inherited by shots for:
- Voice prompt enhancement in Shot Preview
- Downstream TTS processing
- Consistent data availability throughout the pipeline
  </action>
  <verify>
Run: `grep -A5 "'monologue' => \$text" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep emotion`
Expected: Shows "'emotion' => $segment['emotion'] ?? null"

Manual verification: Shot arrays created from speech segments now include emotion field
  </verify>
  <done>Shots created from speech segments include emotion data from the source segment</done>
</task>

</tasks>

<verification>
1. Search for 'hidream' in VideoWizard.php - should return 0 results
2. Count 'nanobanana-pro' in VideoWizard.php - should return 6
3. Verify emotion field exists in createShotsFromSpeechSegments shot array
4. PHP syntax check: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
</verification>

<success_criteria>
- No 'hidream' fallbacks remain in VideoWizard.php
- All 6 imageModel fallback locations use 'nanobanana-pro'
- createShotsFromSpeechSegments() passes emotion data to shots
- PHP file is syntactically valid
</success_criteria>

<output>
After completion, create `.planning/phases/29.1-integration-consistency-fixes/29.1-01-SUMMARY.md`
</output>
