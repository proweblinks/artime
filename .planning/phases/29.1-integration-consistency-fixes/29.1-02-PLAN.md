---
phase: 29.1-integration-consistency-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php
  - modules/AppVideoWizard/resources/views/livewire/modals/shot-preview.blade.php
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Shot Preview displays enhanced voice prompts with emotional direction"
    - "Enhanced prompts include pacing markers from VoiceDirectionVocabulary"
    - "UI shows both original text and enhancement context"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php"
      provides: "Static helper for array-based voice enhancement"
      exports: ["buildSimpleEnhancedPrompt"]
    - path: "modules/AppVideoWizard/resources/views/livewire/modals/shot-preview.blade.php"
      provides: "Enhanced voice prompt display in Shot Preview"
      contains: "buildSimpleEnhancedPrompt"
  key_links:
    - from: "shot-preview.blade.php"
      to: "VoicePromptBuilderService"
      via: "static method call"
      pattern: "VoicePromptBuilderService::buildSimpleEnhancedPrompt"
---

<objective>
Wire VoicePromptBuilderService to Shot Preview modal to display enhanced voice prompts with emotional direction and pacing markers (DEBT-03).

Purpose: Show users the Hollywood-quality voice prompts that will be sent to TTS, not just raw dialogue text
Output: Shot Preview VOICE PROMPT section shows enhanced prompts with emotional tags and direction
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php
@modules/AppVideoWizard/app/Services/VoiceDirectionVocabulary.php
@modules/AppVideoWizard/resources/views/livewire/modals/shot-preview.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add static helper method to VoicePromptBuilderService</name>
  <files>modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php</files>
  <action>
Add a static helper method that works with simple arrays (not SpeechSegment objects) for blade template usage.

Add this method to VoicePromptBuilderService class (after the existing methods, before the closing brace):

```php
/**
 * Build a simple enhanced voice prompt from array data.
 *
 * Static helper for blade templates that don't have SpeechSegment objects.
 * Returns enhanced text with emotional direction tag and description.
 *
 * @param string $text The dialogue/monologue text
 * @param string|null $emotion The emotion key (grief, anxiety, fear, contempt, joy, etc.)
 * @param string $provider TTS provider (elevenlabs, openai, kokoro)
 * @return array{enhanced: string, direction: string, original: string}
 */
public static function buildSimpleEnhancedPrompt(string $text, ?string $emotion = null, string $provider = 'elevenlabs'): array
{
    $result = [
        'enhanced' => $text,
        'direction' => '',
        'original' => $text,
    ];

    if (empty($emotion)) {
        return $result;
    }

    $emotion = strtolower(trim($emotion));
    $directions = VoiceDirectionVocabulary::EMOTIONAL_DIRECTION;

    if (!isset($directions[$emotion])) {
        // Unknown emotion - still show it as direction hint
        $result['direction'] = ucfirst($emotion);
        return $result;
    }

    $emotionData = $directions[$emotion];
    $provider = strtolower($provider);

    // Build enhanced text based on provider
    if ($provider === 'openai') {
        // OpenAI uses separate instructions, return description as direction
        $result['direction'] = $emotionData['description'] ?? '';
    } elseif ($provider === 'kokoro') {
        // Kokoro uses descriptive style
        $result['direction'] = $emotionData['description'] ?? '';
    } else {
        // ElevenLabs and default: use inline tags
        $tag = $emotionData['elevenlabs_tag'] ?? $emotionData['tag'] ?? '';
        if (!empty($tag)) {
            $result['enhanced'] = $tag . ' ' . $text;
        }
        $result['direction'] = $emotionData['description'] ?? '';
    }

    return $result;
}
```

This method:
- Works with simple text + emotion (no SpeechSegment needed)
- Returns both enhanced text and direction description
- Handles unknown emotions gracefully
- Supports all three TTS providers
  </action>
  <verify>
Run: `grep -n "buildSimpleEnhancedPrompt" modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php`
Expected: Shows method definition and docblock

Run: `php -l modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php`
Expected: No syntax errors
  </verify>
  <done>VoicePromptBuilderService has static helper for blade template usage</done>
</task>

<task type="auto">
  <name>Task 2: Update shot-preview.blade.php to use enhanced prompts</name>
  <files>modules/AppVideoWizard/resources/views/livewire/modals/shot-preview.blade.php</files>
  <action>
Update the VOICE PROMPT section (around lines 360-377) to use VoicePromptBuilderService.

Find this block:
```blade
{{-- Voice Prompt --}}
<div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.4rem; padding: 0.4rem;">
    <div style="font-size: 0.6rem; color: rgba(139, 92, 246, 0.9); margin-bottom: 0.2rem; font-weight: 600;">ðŸŽ¤ {{ __('VOICE PROMPT') }}</div>
    <div style="font-size: 0.7rem; color: rgba(196, 181, 253, 0.95); line-height: 1.3; max-height: 50px; overflow-y: auto;">
        @php
            $voiceText = $shot['dialogue'] ?? $shot['monologue'] ?? $shot['narration'] ?? null;
            $emotion = $shot['emotion'] ?? $shot['emotionalTone'] ?? null;
        @endphp
        @if($voiceText)
            @if($emotion)
                <span style="color: rgba(236, 72, 153, 0.9); font-size: 0.6rem;">[{{ $emotion }}]</span>
            @endif
            {{ $voiceText }}
        @else
            {{ __('Silent shot') }}
        @endif
    </div>
</div>
```

Replace with enhanced version:
```blade
{{-- Voice Prompt --}}
<div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.4rem; padding: 0.4rem;">
    <div style="font-size: 0.6rem; color: rgba(139, 92, 246, 0.9); margin-bottom: 0.2rem; font-weight: 600;">ðŸŽ¤ {{ __('VOICE PROMPT') }}</div>
    <div style="font-size: 0.7rem; color: rgba(196, 181, 253, 0.95); line-height: 1.3; max-height: 60px; overflow-y: auto;">
        @php
            $voiceText = $shot['dialogue'] ?? $shot['monologue'] ?? $shot['narration'] ?? null;
            $emotion = $shot['emotion'] ?? $shot['emotionalTone'] ?? null;
            $enhancedPrompt = null;
            if ($voiceText) {
                $enhancedPrompt = \Modules\AppVideoWizard\Services\VoicePromptBuilderService::buildSimpleEnhancedPrompt(
                    $voiceText,
                    $emotion,
                    'elevenlabs'
                );
            }
        @endphp
        @if($voiceText && $enhancedPrompt)
            @if($emotion)
                <span style="color: rgba(236, 72, 153, 0.9); font-size: 0.6rem; font-weight: 500;">[{{ $emotion }}]</span>
            @endif
            @if(!empty($enhancedPrompt['direction']))
                <span style="color: rgba(251, 191, 36, 0.9); font-size: 0.55rem; font-style: italic; display: block; margin: 0.15rem 0;">
                    â†³ {{ $enhancedPrompt['direction'] }}
                </span>
            @endif
            <span style="color: rgba(196, 181, 253, 0.95);">{{ $enhancedPrompt['enhanced'] }}</span>
        @elseif($voiceText)
            {{ $voiceText }}
        @else
            {{ __('Silent shot') }}
        @endif
    </div>
</div>
```

Changes made:
- Increased max-height from 50px to 60px (room for direction line)
- Added VoicePromptBuilderService call to get enhanced prompt
- Kept emotion tag in pink as per M11.2 decision
- Added direction description in amber/gold (rgba(251, 191, 36)) as italicized hint
- Shows enhanced text (with TTS tags) instead of raw dialogue
- Graceful fallback if enhancement fails
  </action>
  <verify>
Run: `grep -n "buildSimpleEnhancedPrompt" modules/AppVideoWizard/resources/views/livewire/modals/shot-preview.blade.php`
Expected: Shows service call in blade template

Run: `grep -n "direction" modules/AppVideoWizard/resources/views/livewire/modals/shot-preview.blade.php`
Expected: Shows direction display logic

Visual verification: Open Shot Preview modal, verify VOICE PROMPT shows:
- Emotion tag in pink (if emotion present)
- Direction description in amber/gold italic (if emotion mapped)
- Enhanced text (may include TTS tags like [nervous])
  </verify>
  <done>Shot Preview displays enhanced voice prompts with emotional direction and pacing context</done>
</task>

</tasks>

<verification>
1. VoicePromptBuilderService::buildSimpleEnhancedPrompt() exists and is callable
2. shot-preview.blade.php calls the service method
3. PHP syntax check both files
4. Manual test: Open Shot Preview for a shot with emotion, verify enhanced display
</verification>

<success_criteria>
- VoicePromptBuilderService has static buildSimpleEnhancedPrompt() method
- Shot Preview VOICE PROMPT section uses enhanced prompts
- Emotion tag shown in pink (existing behavior preserved)
- Direction description shown in amber/gold italic
- Enhanced text shown with TTS-appropriate formatting
- Graceful fallback for shots without emotion or unknown emotions
</success_criteria>

<output>
After completion, create `.planning/phases/29.1-integration-consistency-fixes/29.1-02-SUMMARY.md`
</output>
