---
phase: 25-voice-prompt-enhancement
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php
  - tests/Unit/VideoWizard/VoicePromptBuilderServiceTest.php
  - tests/Feature/VideoWizard/VoicePromptIntegrationTest.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Voice prompts include ambient audio cues for scene atmosphere"
    - "Voice prompts include emotional arc direction across dialogue sequences"
    - "Enhanced voice prompts combine emotional direction, pacing, and ambient cues"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php"
      provides: "Voice prompt assembly integrating all Phase 25 services"
      exports: ["buildEnhancedVoicePrompt", "buildEmotionalArc", "buildAmbientCue"]
    - path: "tests/Unit/VideoWizard/VoicePromptBuilderServiceTest.php"
      provides: "Unit tests for prompt builder"
      min_lines: 120
    - path: "tests/Feature/VideoWizard/VoicePromptIntegrationTest.php"
      provides: "Integration test verifying full voice prompt pipeline"
      min_lines: 80
  key_links:
    - from: "VoicePromptBuilderService"
      to: "VoiceDirectionVocabulary"
      via: "dependency injection"
      pattern: "voiceDirection->wrapWithDirection"
    - from: "VoicePromptBuilderService"
      to: "VoicePacingService"
      via: "dependency injection"
      pattern: "pacingService->insertPauseMarker"
    - from: "VoicePromptBuilderService"
      to: "SpeechSegment"
      via: "segment processing"
      pattern: "segment->emotion"
---

<objective>
Create VoicePromptBuilderService that assembles Hollywood-quality voice prompts by integrating VoiceDirectionVocabulary and VoicePacingService, plus adds ambient audio cues and emotional arc direction.

Purpose: Final integration service for Phase 25 that produces complete enhanced voice prompts. Implements VOC-04 (ambient audio cues) and VOC-06 (emotional arc direction), and integrates VOC-01/02/03/05 from Plans 01-02.

Output: VoicePromptBuilderService.php, unit tests, and feature integration test.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-voice-prompt-enhancement/25-RESEARCH.md

# Dependencies from this phase
@modules/AppVideoWizard/app/Services/VoiceDirectionVocabulary.php
@modules/AppVideoWizard/app/Services/VoicePacingService.php

# Integration points
@modules/AppVideoWizard/app/Services/SpeechSegment.php
@modules/AppVideoWizard/app/Services/VoiceoverService.php
@modules/AppVideoWizard/app/Services/CharacterPsychologyService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VoicePromptBuilderService with ambient cues and emotional arc</name>
  <files>modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php</files>
  <action>
Create VoicePromptBuilderService.php that integrates all Phase 25 vocabulary services.

**Dependencies (inject via constructor):**
- VoiceDirectionVocabulary $voiceDirection
- VoicePacingService $pacingService

**AMBIENT_AUDIO_CUES constant (VOC-04):**
Scene atmosphere suggestions for audio mixing, not TTS tags:
```php
public const AMBIENT_AUDIO_CUES = [
    'intimate' => 'quiet room tone, minimal background, close mic presence',
    'outdoor' => 'subtle wind, distant nature sounds, open acoustic',
    'crowded' => 'background murmur, ambient conversation, bustling atmosphere',
    'tense' => 'silence heavy with anticipation, muted background',
    'storm' => 'rain and thunder ambient, howling wind',
    'night' => 'crickets, distant traffic, nighttime quiet',
    'office' => 'keyboard clicks, AC hum, muffled phone',
    'vehicle' => 'engine hum, road noise, confined acoustic',
];
```

**EMOTIONAL_ARC_PATTERNS constant (VOC-06):**
Named arc progressions for dialogue sequences:
```php
public const EMOTIONAL_ARC_PATTERNS = [
    'building' => ['quiet', 'rising', 'intense', 'peak'],
    'crashing' => ['confident', 'wavering', 'breaking', 'collapsed'],
    'recovering' => ['broken', 'struggling', 'gathering', 'resolved'],
    'masking' => ['controlled', 'slipping', 'recovering', 'forced'],
    'revealing' => ['guarded', 'hesitant', 'opening', 'vulnerable'],
    'confronting' => ['calm', 'challenged', 'defensive', 'explosive'],
];
```

**Main methods:**

1. `buildEnhancedVoicePrompt(SpeechSegment $segment, array $options = []): array`
   - Returns `['text' => enhanced text, 'instructions' => provider instructions, 'ambient' => cue]`
   - Options: `provider` (elevenlabs|openai|kokoro), `includeAmbient` (bool), `arcPosition` (string)
   - Calls voiceDirection->wrapWithDirection() for emotional tags
   - If segment has emotion, adds direction; if not, returns text unchanged
   - Returns array with both enhanced text AND separate instructions for OpenAI style

2. `buildEmotionalArc(array $segments, string $arcType = 'building'): array`
   - Takes array of SpeechSegment objects
   - Assigns arc position note to each segment based on position in sequence
   - Returns segments with `emotionalArcNote` set
   - Formula: `$position = min(floor($index / count($segments) * 4), 3)` to distribute 4 arc stages

3. `buildAmbientCue(string $sceneType): string`
   - Returns ambient audio cue description for scene type
   - Falls back to 'intimate' for unknown types

4. `buildDialogueDirectionPrompt(array $segments, string $arcType, string $sceneType, string $provider = 'elevenlabs'): array`
   - High-level method that processes full dialogue sequence
   - Applies emotional arc across segments
   - Builds ambient cue
   - Returns complete prompt package: `['segments' => [...], 'arcSummary' => string, 'ambient' => string]`
   - Arc summary example: "Start defeated and quiet, build to desperate pleading by third line, crack into tears on final word"

5. `buildArcSummary(string $arcType, int $segmentCount): string`
   - Generates human-readable arc direction for voice actors
   - Example: "Start quiet, build through rising intensity, reach emotional peak on final line"

**Important patterns:**
- Provider-agnostic core, provider-specific output
- OpenAI: instructions passed separately (not inline tags)
- ElevenLabs: inline tags like [crying]
- Kokoro: descriptive text style ("she whispered")
  </action>
  <verify>
```bash
php -l modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php
```
File has no syntax errors and contains AMBIENT_AUDIO_CUES and EMOTIONAL_ARC_PATTERNS constants.
  </verify>
  <done>VoicePromptBuilderService.php exists with ambient cue constants, emotional arc patterns, and integration methods for building enhanced voice prompts.</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for VoicePromptBuilderService</name>
  <files>tests/Unit/VideoWizard/VoicePromptBuilderServiceTest.php</files>
  <action>
Create comprehensive unit tests for the prompt builder.

**Test cases:**

1. `test_buildEnhancedVoicePrompt_adds_emotional_direction` - Segment with emotion gets wrapped with direction tags
2. `test_buildEnhancedVoicePrompt_returns_unchanged_without_emotion` - Segment without emotion returns original text
3. `test_buildEnhancedVoicePrompt_uses_provider_specific_tags` - ElevenLabs gets [crying], OpenAI gets instructions object
4. `test_buildEnhancedVoicePrompt_includes_ambient_when_requested` - includeAmbient option adds ambient cue
5. `test_buildEmotionalArc_assigns_arc_notes` - Segments get emotionalArcNote based on position
6. `test_buildEmotionalArc_handles_single_segment` - Single segment gets first arc position
7. `test_buildEmotionalArc_handles_many_segments` - 8 segments get distributed arc positions
8. `test_buildEmotionalArc_uses_correct_pattern` - 'crashing' arc uses confident->wavering->breaking->collapsed
9. `test_buildAmbientCue_returns_cue_for_known_type` - 'tense' returns tension description
10. `test_buildAmbientCue_returns_fallback_for_unknown_type` - Unknown type returns 'intimate' fallback
11. `test_buildDialogueDirectionPrompt_returns_complete_package` - Returns segments, arcSummary, ambient
12. `test_buildArcSummary_describes_progression` - Summary includes start and end emotional states

Run tests:
```bash
php artisan test --filter=VoicePromptBuilderServiceTest
```
  </action>
  <verify>
```bash
php artisan test --filter=VoicePromptBuilderServiceTest
```
All tests pass.
  </verify>
  <done>Unit tests verify enhanced prompt building, emotional arc assignment, ambient cue retrieval, and full dialogue direction.</done>
</task>

<task type="auto">
  <name>Task 3: Create feature integration test for voice prompt pipeline</name>
  <files>tests/Feature/VideoWizard/VoicePromptIntegrationTest.php</files>
  <action>
Create feature test that verifies the complete voice prompt enhancement pipeline.

**Integration test scenarios:**

1. `test_full_voice_prompt_enhancement_pipeline`
   - Create 3 SpeechSegment objects (dialogue with emotions: anxiety, grief, fear)
   - Process through VoicePromptBuilderService::buildDialogueDirectionPrompt()
   - Verify: Each segment has emotional direction, arc notes assigned, ambient cue present
   - Assert final output includes bracketed tags for ElevenLabs provider

2. `test_voice_prompt_includes_all_voc_requirements`
   - Create segment with grief emotion
   - Build enhanced prompt for ElevenLabs
   - VOC-01: Assert contains emotional direction tag like [crying] or [grieving]
   - VOC-02: Assert can add pacing markers via pacingService
   - VOC-03: Assert vocal quality can be retrieved for segment
   - VOC-04: Assert ambient cue present in output
   - VOC-05: Assert non-verbal sounds available via vocabulary
   - VOC-06: Assert arc summary describes emotional progression

3. `test_openai_provider_returns_instructions_separately`
   - Build enhanced prompt for OpenAI provider
   - Assert text does NOT contain bracketed tags
   - Assert instructions array contains emotional direction description

4. `test_emotional_arc_spans_dialogue_sequence`
   - Create 4 segments representing conversation
   - Apply 'building' arc
   - Assert first segment has 'quiet' note, last has 'peak' note
   - Assert arc summary describes "start quiet...reach peak"

**Test setup:**
- Instantiate real VoiceDirectionVocabulary and VoicePacingService
- Inject into VoicePromptBuilderService
- Create SpeechSegment objects using factory methods

Run tests:
```bash
php artisan test --filter=VoicePromptIntegrationTest
```
  </action>
  <verify>
```bash
php artisan test --filter=VoicePromptIntegrationTest
```
All integration tests pass.
  </verify>
  <done>Feature integration test verifies complete voice prompt enhancement pipeline meets all VOC requirements.</done>
</task>

</tasks>

<verification>
```bash
# Syntax check
php -l modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php

# Unit tests
php artisan test --filter=VoicePromptBuilderServiceTest

# Integration tests
php artisan test --filter=VoicePromptIntegrationTest

# Full integration check
php artisan tinker --execute="
use Modules\AppVideoWizard\Services\VoicePromptBuilderService;
use Modules\AppVideoWizard\Services\VoiceDirectionVocabulary;
use Modules\AppVideoWizard\Services\VoicePacingService;
use Modules\AppVideoWizard\Services\SpeechSegment;

\$builder = new VoicePromptBuilderService(new VoiceDirectionVocabulary(), new VoicePacingService());
\$segment = SpeechSegment::dialogue('ALICE', 'I thought you were gone forever.');
\$segment->emotion = 'grief';
\$result = \$builder->buildEnhancedVoicePrompt(\$segment, ['provider' => 'elevenlabs']);
var_dump(\$result);
"
```
</verification>

<success_criteria>
1. VoicePromptBuilderService.php exists with AMBIENT_AUDIO_CUES (8 types) and EMOTIONAL_ARC_PATTERNS (6 arcs)
2. `buildEnhancedVoicePrompt(segment, ['provider' => 'elevenlabs'])` returns text with emotional tags
3. `buildEmotionalArc(segments, 'building')` assigns quiet->rising->intense->peak notes
4. `buildDialogueDirectionPrompt(segments, 'crashing', 'tense')` returns complete prompt package
5. OpenAI provider returns instructions separately (not inline tags)
6. All unit and feature tests pass
7. Integration test verifies VOC-01 through VOC-06 requirements
</success_criteria>

<output>
After completion, create `.planning/phases/25-voice-prompt-enhancement/25-03-SUMMARY.md`
</output>
