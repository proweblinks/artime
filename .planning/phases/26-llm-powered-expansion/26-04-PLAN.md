---
phase: 26-llm-powered-expansion
plan: 04
type: execute
wave: 1
depends_on: ["01", "02", "03"]
files_modified:
  - modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php
  - tests/Feature/VideoWizard/LLMExpansionIntegrationTest.php
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All callers of build() automatically get LLM expansion for complex shots"
    - "Simple shots continue using template path (no regression)"
    - "Prompt building produces same output structure regardless of entry point (build vs buildHollywoodPrompt)"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php"
      provides: "build() delegates to buildHollywoodPrompt()"
      contains: "return $this->buildHollywoodPrompt"
  key_links:
    - from: "StructuredPromptBuilderService::build()"
      to: "StructuredPromptBuilderService::buildHollywoodPrompt()"
      via: "delegation call"
      pattern: "return \\$this->buildHollywoodPrompt"
---

<objective>
Close verification gap: Ensure all existing callers of build() automatically receive LLM expansion for complex shots

Purpose: The LLM expansion infrastructure is complete but requires callers to use buildHollywoodPrompt() instead of build(). This gap closure modifies build() to delegate to buildHollywoodPrompt() internally, providing backward compatibility while enabling automatic LLM expansion for all callers including ImageGenerationService.

Output: Modified StructuredPromptBuilderService where build() delegates to buildHollywoodPrompt(), ensuring all prompt building flows through complexity detection
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-llm-powered-expansion/26-03-SUMMARY.md
@.planning/phases/26-llm-powered-expansion/26-VERIFICATION.md

# Key files
@modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor build() to delegate to buildHollywoodPrompt()</name>
  <files>modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php</files>
  <action>
Modify the build() method to delegate to buildHollywoodPrompt() for automatic LLM routing.

Current build() method (around line 735):
```php
public function build(array $options): array
{
    $visualMode = $options['visual_mode'] ?? 'cinematic-realistic';
    // ... full implementation ...
    return $structuredPrompt;
}
```

Refactor to:

1. Rename current build() to buildTemplate() - this is the pure template-based implementation
2. Create new build() that delegates to buildHollywoodPrompt()

New structure:
```php
/**
 * Build a complete structured prompt from scene data.
 * Automatically routes through LLM expansion for complex shots.
 *
 * @param array $options Configuration options
 * @return array Structured prompt data
 */
public function build(array $options): array
{
    return $this->buildHollywoodPrompt($options);
}

/**
 * Build a structured prompt using template-based expansion only.
 * Called by buildHollywoodPrompt() for non-complex shots or as fallback.
 *
 * @param array $options Configuration options
 * @return array Structured prompt data
 */
public function buildTemplate(array $options): array
{
    // Move the ENTIRE current build() implementation here unchanged
    $visualMode = $options['visual_mode'] ?? 'cinematic-realistic';
    // ... rest of current implementation ...
}
```

3. CRITICAL - Update buildHollywoodPrompt() to call buildTemplate() instead of build() (line 716):
```php
// Use template-based prompt building (existing flow)
$result = $this->buildTemplate($options);
```

This change ensures:
- All existing callers of build() automatically get LLM routing
- Simple shots use template path via buildHollywoodPrompt() -> buildTemplate()
- Complex shots use LLM path via buildHollywoodPrompt() -> LLMExpansionService
- No circular calls (build -> buildHollywoodPrompt -> buildTemplate)

DO NOT change any logic - this is pure method delegation refactoring.
  </action>
  <verify>
1. Verify build() delegates to buildHollywoodPrompt():
   grep for "return \$this->buildHollywoodPrompt" in StructuredPromptBuilderService.php - should find 1 match in build() method

2. CRITICAL - Verify NO circular call in buildHollywoodPrompt():
   Search buildHollywoodPrompt() method body for "$this->build(" - should return 0 matches
   Instead, should find "$this->buildTemplate(" in buildHollywoodPrompt()

3. Verify buildTemplate() exists:
   grep for "function buildTemplate" in StructuredPromptBuilderService.php - should find 1 match

4. Run tests: `php artisan test --filter=LLMExpansionIntegrationTest`
   All 9 tests should pass - they already call buildHollywoodPrompt() so behavior is unchanged.
  </verify>
  <done>
build() method delegates to buildHollywoodPrompt(), buildHollywoodPrompt() calls buildTemplate() (not build()), no circular call exists, all existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test for build() delegation</name>
  <files>tests/Feature/VideoWizard/LLMExpansionIntegrationTest.php</files>
  <action>
Add a single test to verify that build() produces the same output as buildHollywoodPrompt().

Add this test to LLMExpansionIntegrationTest.php:

```php
/**
 * @test
 * Test that build() delegates to buildHollywoodPrompt() for automatic LLM routing.
 * This ensures backward compatibility - existing callers get LLM expansion without code changes.
 */
public function test_build_delegates_to_hollywood_prompt()
{
    $options = [
        'visual_mode' => 'cinematic-realistic',
        'shot_type' => 'close-up',
        'emotion' => 'grief',
        'scene_description' => 'A woman looks out the window',
    ];

    // Both methods should produce identical output
    $buildResult = $this->builder->build($options);
    $hollywoodResult = $this->builder->buildHollywoodPrompt($options);

    // Verify identical structure
    $this->assertEquals($buildResult['meta_data'], $hollywoodResult['meta_data']);
    $this->assertEquals($buildResult['creative_prompt'], $hollywoodResult['creative_prompt']);
    $this->assertEquals($buildResult['llm_metadata'], $hollywoodResult['llm_metadata']);
}
```

This test confirms:
- build() and buildHollywoodPrompt() produce identical results
- Backward compatibility is maintained
- LLM metadata is present in build() output (proving it went through buildHollywoodPrompt)
  </action>
  <verify>
Run: `php artisan test --filter=test_build_delegates_to_hollywood_prompt`
Test should pass.

Run: `php artisan test --filter=LLMExpansionIntegrationTest`
All 10 tests (9 existing + 1 new) should pass.
  </verify>
  <done>
New test confirms build() delegates to buildHollywoodPrompt(), all 10 tests pass
  </done>
</task>

</tasks>

<verification>
1. All LLMExpansionIntegrationTest tests pass (10 tests)
2. build() contains delegation to buildHollywoodPrompt()
3. buildTemplate() exists with original build() implementation
4. buildHollywoodPrompt() calls buildTemplate() (not build()) - CRITICAL for avoiding infinite loop
5. No circular method calls - verify by grep: "$this->build(" should NOT appear in buildHollywoodPrompt() method body
6. Backward compatibility check:
   - Search codebase for all callers of "->build(" on StructuredPromptBuilderService
   - Run: `grep -r "->build(" --include="*.php" modules/ app/ | grep -i "StructuredPromptBuilder\|promptBuilder"`
   - All identified callers should continue to work (verified by test suite passing)
</verification>

<success_criteria>
1. build() method delegates to buildHollywoodPrompt() - verified by grep
2. buildHollywoodPrompt() calls buildTemplate() not build() - verified by grep (no "$this->build(" in method)
3. All 10 integration tests pass - verified by test run
4. ImageGenerationService (and all other callers of build()) automatically get LLM expansion for complex shots without code changes
5. Simple shots still use template path (complexity detection routes them through buildTemplate)
</success_criteria>

<output>
After completion, create `.planning/phases/26-llm-powered-expansion/26-04-SUMMARY.md`
</output>
