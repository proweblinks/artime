---
phase: 02-narrative-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "AI prompt includes narrative moment descriptions for each target shot"
    - "AI prompt includes emotional arc visualization (percentage progression)"
    - "Shot count guidance aligns with narrative moment count"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ShotIntelligenceService.php"
      provides: "Narrative-enhanced AI prompt template"
      contains: "narrative_moments"
  key_links:
    - from: "buildAnalysisPrompt()"
      to: "context['narrativeMoments']"
      via: "template variable substitution"
      pattern: "\\{\\{narrative_moments\\}\\}"
---

<objective>
Enhance the AI shot analysis prompt to include narrative moment decomposition, giving the AI explicit guidance on what unique action each shot should capture.

Purpose: Prevent duplicate/similar shot descriptions by providing pre-decomposed moments with unique actions and emotional intensity progression. This is the key integration that makes "Hollywood-standard: every shot = unique moment" work.

Output: AI prompts that include specific narrative moments with action, emotion, and suggested shot type for each shot.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-narrative-intelligence/02-RESEARCH.md
@.planning/phases/02-narrative-intelligence/02-01-SUMMARY.md

# Key source files
@modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
@modules/AppVideoWizard/app/Services/NarrativeMomentService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add narrative moment formatting method</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Add a new protected method to format narrative moments for the AI prompt. Place this after the `getSceneTypeShotGuidance()` method (around line 432):

```php
/**
 * Format narrative moments for AI prompt.
 * Creates detailed shot guidance based on pre-decomposed narrative moments.
 *
 * @param array $narrativeMoments Array of moment objects from NarrativeMomentService
 * @return string Formatted moment descriptions for AI prompt
 */
protected function formatNarrativeMomentsForPrompt(array $narrativeMoments): string
{
    if (empty($narrativeMoments)) {
        return '';
    }

    $lines = [];
    $lines[] = 'NARRATIVE MOMENTS (CRITICAL - Use these exact moments for each shot):';
    $lines[] = '';

    foreach ($narrativeMoments as $index => $moment) {
        $shotNum = $index + 1;
        $action = $moment['action'] ?? 'continues';
        $emotion = $moment['emotion'] ?? 'focus';
        $intensity = $moment['intensity'] ?? 0.5;
        $subject = $moment['subject'] ?? 'the subject';

        // Get suggested shot type based on intensity
        $suggestedType = $this->getShotTypeFromIntensity($intensity, $index, count($narrativeMoments));

        $lines[] = sprintf(
            "Shot %d: ACTION=\"%s\" | EMOTION=%s | INTENSITY=%.0f%% | SUGGESTED=%s",
            $shotNum,
            $action,
            $emotion,
            $intensity * 100,
            $suggestedType
        );

        // Add visual description if available
        if (!empty($moment['visualDescription'])) {
            $lines[] = sprintf("         VISUAL: %s", $moment['visualDescription']);
        }
    }

    $lines[] = '';
    $lines[] = 'IMPORTANT: Each shot MUST use its assigned ACTION. Do NOT reuse actions between shots.';

    return implode("\n", $lines);
}

/**
 * Get shot type suggestion based on emotional intensity.
 * Maps intensity to shot type following Hollywood cinematography standards.
 *
 * @param float $intensity Emotional intensity (0-1)
 * @param int $index Shot index
 * @param int $total Total shots
 * @return string Suggested shot type
 */
protected function getShotTypeFromIntensity(float $intensity, int $index, int $total): string
{
    // First shot: establishing (unless very short sequence)
    if ($index === 0 && $total > 2) {
        return 'establishing';
    }

    // Last shot: character-centric
    if ($index === $total - 1) {
        return $intensity > 0.6 ? 'close-up' : 'medium';
    }

    // Intensity-based (Hollywood analysis):
    // 0.85-1.0: Extreme close-up (peak emotional)
    // 0.7-0.85: Close-up (high emotion)
    // 0.55-0.7: Medium close-up
    // 0.4-0.55: Medium (dialogue, standard)
    // 0.25-0.4: Wide (context)
    // 0.0-0.25: Establishing (location)
    if ($intensity >= 0.85) return 'extreme-close-up';
    if ($intensity >= 0.7) return 'close-up';
    if ($intensity >= 0.55) return 'medium-close';
    if ($intensity >= 0.4) return 'medium';
    if ($intensity >= 0.25) return 'wide';
    return 'establishing';
}

/**
 * Format emotional arc for AI prompt.
 * Shows intensity progression as percentages.
 *
 * @param array $emotionalArc Array of intensity values (0-1)
 * @return string Formatted arc string
 */
protected function formatEmotionalArcForPrompt(array $emotionalArc): string
{
    if (empty($emotionalArc)) {
        return 'Not available';
    }

    $percentages = array_map(
        fn($i) => round($i * 100) . '%',
        $emotionalArc
    );

    return implode(' -> ', $percentages);
}
```

WHY: Separate methods keep buildAnalysisPrompt() clean. Replicates NarrativeMomentService.getShotTypeForIntensity() logic locally to avoid circular dependency concerns.
  </action>
  <verify>
    - formatNarrativeMomentsForPrompt() method exists and is protected
    - getShotTypeFromIntensity() method exists and is protected
    - formatEmotionalArcForPrompt() method exists and is protected
    - Methods follow intensity mapping from research (0.85+ = XCU, 0.7+ = CU, etc.)
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>Formatting methods for narrative moments and emotional arc are available</done>
</task>

<task type="auto">
  <name>Task 2: Integrate narrative moments into buildAnalysisPrompt</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Modify buildAnalysisPrompt() method (starts at line 308) to include narrative moment data in the template variables:

1. Add narrative moment formatting after getting shot count guidance (around line 320), before the $variables array:

```php
// PHASE 2: Format narrative moments if available
$narrativeMomentsText = '';
$emotionalArcText = 'Not available';
if (!empty($context['narrativeMoments'])) {
    $narrativeMomentsText = $this->formatNarrativeMomentsForPrompt($context['narrativeMoments']);

    // Update target shot count to match moment count for consistency
    $momentCount = count($context['narrativeMoments']);
    if ($momentCount > 0) {
        $shotCountGuidance = "REQUIRED: Generate exactly {$momentCount} shots to match the {$momentCount} narrative moments provided.";
    }
}
if (!empty($context['emotionalArc'])) {
    $emotionalArcText = $this->formatEmotionalArcForPrompt($context['emotionalArc']);
}
```

2. Add new variables to the $variables array (around line 341):

```php
// Phase 2: Narrative moment context
'narrative_moments' => $narrativeMomentsText,
'emotional_arc_visualization' => $emotionalArcText,
```

3. Update the default prompt template in getDefaultPrompt() (starts line 1164) to include the new variables. Add this section AFTER the "NARRATIVE BEAT RULES" section (around line 1186):

```php
NARRATIVE MOMENT DECOMPOSITION (Phase 2 - Hollywood Standard):
{{narrative_moments}}

EMOTIONAL ARC: {{emotional_arc_visualization}}
```

Find the line containing `{{narrative_beat_rules}}` and add the new section right after it.

WHY: This places narrative moments prominently in the AI prompt, ensuring the AI sees specific actions for each shot before generating its breakdown. The "REQUIRED" shot count guidance forces alignment.
  </action>
  <verify>
    - buildAnalysisPrompt() contains `$this->formatNarrativeMomentsForPrompt`
    - $variables array contains 'narrative_moments' and 'emotional_arc_visualization' keys
    - getDefaultPrompt() contains `{{narrative_moments}}` placeholder
    - getDefaultPrompt() contains `{{emotional_arc_visualization}}` placeholder
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>AI prompt includes narrative moments with unique actions and emotional arc progression</done>
</task>

<task type="auto">
  <name>Task 3: Update shot count to align with moment count</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Ensure parseAIResponse() respects narrative moment count when validating shot count. Modify parseAIResponse() (starts at line 620):

1. Update the method signature to accept narrative moment count:

Find the line:
```php
protected function parseAIResponse(string $response, array $scene, int $minShots, int $maxShots): array
```

Change to:
```php
protected function parseAIResponse(string $response, array $scene, int $minShots, int $maxShots, ?int $narrativeMomentCount = null): array
```

2. Update the shot count validation (around line 638-639):

Find:
```php
$shotCount = isset($data['shotCount']) ? (int) $data['shotCount'] : count($data['shots'] ?? []);
$shotCount = max($minShots, min($maxShots, $shotCount));
```

Replace with:
```php
$shotCount = isset($data['shotCount']) ? (int) $data['shotCount'] : count($data['shots'] ?? []);

// PHASE 2: If narrative moments were provided, prefer that count
if ($narrativeMomentCount !== null && $narrativeMomentCount > 0) {
    // Use moment count, but still respect min/max bounds
    $shotCount = max($minShots, min($maxShots, $narrativeMomentCount));
} else {
    $shotCount = max($minShots, min($maxShots, $shotCount));
}
```

3. Update the call to parseAIResponse() in analyzeScene() (around line 169) to pass narrative moment count:

Find:
```php
$analysis = $this->parseAIResponse($aiResponse['response'], $scene, $minShots, $maxShots);
```

Replace with:
```php
$narrativeMomentCount = !empty($narrativeMoments) ? count($narrativeMoments) : null;
$analysis = $this->parseAIResponse($aiResponse['response'], $scene, $minShots, $maxShots, $narrativeMomentCount);
```

WHY: Ensures shot count aligns with decomposed moments. If we decompose narration into 4 moments, we should generate 4 shots - not 5 or 3.
  </action>
  <verify>
    - parseAIResponse() signature includes `?int $narrativeMomentCount = null`
    - Shot count validation considers $narrativeMomentCount when available
    - analyzeScene() passes moment count to parseAIResponse()
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>Shot count aligns with narrative moment count while respecting min/max bounds</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
2. Grep for new elements:
   - `grep -n "formatNarrativeMomentsForPrompt" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
   - `grep -n "narrative_moments" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
   - `grep -n "narrativeMomentCount" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
3. Default prompt contains narrative moment section
4. buildAnalysisPrompt() adds narrative context to variables
</verification>

<success_criteria>
- AI prompt includes detailed narrative moment descriptions with action, emotion, intensity
- AI prompt shows emotional arc progression (percentage visualization)
- Shot count aligns with narrative moment count
- Each shot gets guidance on its unique action
- Methods follow existing code patterns
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/02-narrative-intelligence/02-02-SUMMARY.md`
</output>
