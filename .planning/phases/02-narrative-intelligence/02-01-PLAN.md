---
phase: 02-narrative-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "ShotIntelligenceService has NarrativeMomentService as constructor dependency"
    - "analyzeScene() calls decomposeNarrationIntoMoments() for each scene"
    - "Narrative moments are available during prompt building"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/ShotIntelligenceService.php"
      provides: "NarrativeMomentService integration"
      contains: "NarrativeMomentService"
  key_links:
    - from: "ShotIntelligenceService.php"
      to: "NarrativeMomentService"
      via: "constructor injection and analyzeScene() call"
      pattern: "narrativeMomentService->decomposeNarrationIntoMoments"
---

<objective>
Wire NarrativeMomentService into ShotIntelligenceService's shot analysis pipeline.

Purpose: Enable Hollywood-standard narrative decomposition where each shot captures a unique narrative moment with emotional progression. The service already exists (711 lines, 80% complete) but is not connected to shot generation.

Output: ShotIntelligenceService that decomposes narration into distinct moments before AI shot analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-narrative-intelligence/02-RESEARCH.md

# Key source files
@modules/AppVideoWizard/app/Services/ShotIntelligenceService.php
@modules/AppVideoWizard/app/Services/NarrativeMomentService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NarrativeMomentService dependency to ShotIntelligenceService</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Add NarrativeMomentService as an optional constructor dependency to ShotIntelligenceService, following the existing pattern for other services (ShotContinuityService, SceneTypeDetectorService, etc.):

1. Add import at top of file:
   ```php
   use Modules\AppVideoWizard\Services\NarrativeMomentService;
   ```

2. Add protected property after line 68 (after progressionService):
   ```php
   /**
    * Phase 2: Narrative moment service for Hollywood-standard decomposition.
    */
   protected ?NarrativeMomentService $narrativeMomentService = null;
   ```

3. Update constructor signature (line 70-76) to add parameter:
   ```php
   public function __construct(
       ?ShotContinuityService $continuityService = null,
       ?SceneTypeDetectorService $sceneTypeDetector = null,
       ?CameraMovementService $cameraMovementService = null,
       ?VideoPromptBuilderService $videoPromptBuilder = null,
       ?ShotProgressionService $progressionService = null,
       ?NarrativeMomentService $narrativeMomentService = null
   ) {
   ```

4. Add assignment inside constructor:
   ```php
   $this->narrativeMomentService = $narrativeMomentService;
   ```

5. Add setter method after setProgressionService() (around line 123):
   ```php
   /**
    * Set the narrative moment service (for dependency injection).
    */
   public function setNarrativeMomentService(NarrativeMomentService $service): void
   {
       $this->narrativeMomentService = $service;
   }
   ```

WHY this pattern: Matches existing service injection pattern in ShotIntelligenceService. Optional parameter ensures backward compatibility.
  </action>
  <verify>
    - File contains `use Modules\AppVideoWizard\Services\NarrativeMomentService;`
    - File contains `protected ?NarrativeMomentService $narrativeMomentService`
    - Constructor includes `?NarrativeMomentService $narrativeMomentService = null`
    - setNarrativeMomentService() method exists
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>NarrativeMomentService is injectable into ShotIntelligenceService via constructor or setter</done>
</task>

<task type="auto">
  <name>Task 2: Call decomposeNarrationIntoMoments in analyzeScene</name>
  <files>modules/AppVideoWizard/app/Services/ShotIntelligenceService.php</files>
  <action>
Modify analyzeScene() method (starts at line 139) to decompose narration into moments BEFORE building the AI prompt:

1. Inside analyzeScene(), after scene type detection (around line 148) and before building the analysis prompt (line 156), add narrative moment decomposition:

```php
// PHASE 2: Decompose narration into narrative moments if service available
$narrativeMoments = null;
$emotionalArc = null;
if ($this->narrativeMomentService) {
    $narration = $scene['narration'] ?? '';
    if (!empty($narration)) {
        // Calculate target shot count from settings
        $targetShotCount = (int) VwSetting::getValue('shot_min_per_scene', 5);

        // Build decomposition context
        $momentContext = [
            'characters' => $context['characters'] ?? [],
            'mood' => $scene['mood'] ?? $context['mood'] ?? 'neutral',
            'genre' => $context['genre'] ?? 'general',
            'sceneType' => $context['sceneType'] ?? 'dialogue',
        ];

        try {
            $narrativeMoments = $this->narrativeMomentService->decomposeNarrationIntoMoments(
                $narration,
                $targetShotCount,
                $momentContext
            );

            if (!empty($narrativeMoments)) {
                $emotionalArc = $this->narrativeMomentService->extractEmotionalArc($narrativeMoments);
                $context['narrativeMoments'] = $narrativeMoments;
                $context['emotionalArc'] = $emotionalArc;

                Log::info('ShotIntelligenceService: Narrative moments decomposed', [
                    'scene_id' => $scene['id'] ?? 'unknown',
                    'moment_count' => count($narrativeMoments),
                    'arc' => $emotionalArc,
                ]);
            }
        } catch (\Throwable $e) {
            Log::warning('ShotIntelligenceService: Narrative decomposition failed', [
                'error' => $e->getMessage(),
            ]);
        }
    }
}
```

2. Add narrative moments to the final analysis result (around line 196, before the return):

```php
// Add narrative moment analysis if available
if (!empty($narrativeMoments)) {
    $analysis['narrativeMoments'] = $narrativeMoments;
    $analysis['emotionalArc'] = $emotionalArc;
}
```

WHY this placement: Decompose BEFORE prompt building so moments can inform AI. Store in context so buildAnalysisPrompt() can access them.
  </action>
  <verify>
    - analyzeScene() contains `$this->narrativeMomentService->decomposeNarrationIntoMoments`
    - Context gets `narrativeMoments` and `emotionalArc` keys assigned
    - Analysis result includes `narrativeMoments` when available
    - Log::info for successful decomposition
    - try/catch around decomposition
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
  </verify>
  <done>analyzeScene() decomposes narration into moments and passes them to prompt building and includes them in output</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
2. Grep for integration:
   - `grep -n "NarrativeMomentService" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
   - `grep -n "narrativeMoments" modules/AppVideoWizard/app/Services/ShotIntelligenceService.php`
3. Constructor has 6 optional parameters
4. setNarrativeMomentService() method exists
</verification>

<success_criteria>
- NarrativeMomentService is a constructor dependency of ShotIntelligenceService
- analyzeScene() calls decomposeNarrationIntoMoments() when service available
- Narrative moments and emotional arc are added to context for prompt building
- Analysis result includes narrativeMoments and emotionalArc arrays
- All changes follow existing patterns in the codebase
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/02-narrative-intelligence/02-01-SUMMARY.md`
</output>
