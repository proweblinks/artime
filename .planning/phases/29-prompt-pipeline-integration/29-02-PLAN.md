---
phase: 29-prompt-pipeline-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Shot prompts include CHARACTERS section with character descriptions"
    - "Shot prompts include LOCATION section with location details"
    - "Shot Preview IMAGE PROMPT displays rich, story-specific content"
    - "Character names and descriptions appear in generated image prompts"
    - "Location name, type, and atmosphere appear in generated image prompts"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Enhanced buildEnhancedShotImagePrompt method"
      contains: "CHARACTERS:"
  key_links:
    - from: "buildEnhancedShotImagePrompt"
      to: "sceneMemory.characterBible"
      via: "getCharactersForSceneIndex lookup"
      pattern: "getCharactersForSceneIndex"
    - from: "buildEnhancedShotImagePrompt"
      to: "sceneMemory.locationBible"
      via: "getLocationForSceneIndex lookup"
      pattern: "getLocationForSceneIndex"
---

<objective>
Enhance buildEnhancedShotImagePrompt() to include Character DNA (character descriptions) and Location DNA (location details) from Scene Memory.

Purpose: Shot-level image prompts are currently generic because they don't include character appearance info or location context. The comprehensive buildScenePrompt() method has this logic but it's not used for individual shot generation.

Output: Shot prompts will include CHARACTERS and LOCATION sections like buildScenePrompt does, producing visually richer, story-specific images.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-prompt-pipeline-integration/29-CONTEXT.md
@modules/AppVideoWizard/app/Livewire/VideoWizard.php (lines 11157-11257 for buildScenePrompt reference)
@modules/AppVideoWizard/app/Livewire/VideoWizard.php (lines 20862-20910 for buildEnhancedShotImagePrompt)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sceneIndex parameter to buildEnhancedShotImagePrompt</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Modify the method signature at line 20862 to add a sceneIndex parameter:

```php
protected function buildEnhancedShotImagePrompt(array $shot, int $sceneIndex = 0): string
```

The sceneIndex is needed to look up which characters and location apply to this shot's scene.

Then update all callers of this method to pass the sceneIndex. Search for `buildEnhancedShotImagePrompt(` and add the scene index where available from context.

Common call patterns to update:
- Calls within loops over scenes: pass $sceneIndex or $index
- Calls within decomposed scene processing: pass the scene index from context
  </action>
  <verify>
Run: `grep -n "buildEnhancedShotImagePrompt(" modules/AppVideoWizard/app/Livewire/VideoWizard.php`

Verify method signature has `int $sceneIndex = 0` parameter.
  </verify>
  <done>
Method accepts sceneIndex parameter for context-aware character and location lookup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Character Bible integration (Layer 2)</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
In buildEnhancedShotImagePrompt(), after the shot type description (step 1) and before the unique visual description (step 2), add Character Bible integration:

```php
// 1.5. CHARACTER BIBLE (Characters in this scene) - from buildScenePrompt Layer 2
if ($this->sceneMemory['characterBible']['enabled'] ?? false) {
    $characters = $this->sceneMemory['characterBible']['characters'] ?? [];
    $sceneCharacters = $this->getCharactersForSceneIndex($characters, $sceneIndex);

    if (!empty($sceneCharacters)) {
        $characterDescriptions = [];
        foreach ($sceneCharacters as $character) {
            if (!empty($character['description'])) {
                $name = $character['name'] ?? 'Character';
                $charDesc = "{$name}: {$character['description']}";

                // Include traits if available for personality/expression guidance
                $traits = $character['traits'] ?? [];
                if (!empty($traits)) {
                    $charDesc .= ' (personality: ' . implode(', ', array_slice($traits, 0, 4)) . ')';
                }

                $characterDescriptions[] = $charDesc;
            }
        }
        if (!empty($characterDescriptions)) {
            $parts[] = 'CHARACTERS: ' . implode('. ', $characterDescriptions);
        }
    }
}
```

This is copied directly from buildScenePrompt() lines 11193-11216 for consistency.
  </action>
  <verify>
Run: `grep -A5 "CHARACTER BIBLE" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -A5 "buildEnhancedShotImagePrompt" || grep -B2 -A10 "CHARACTERS:" modules/AppVideoWizard/app/Livewire/VideoWizard.php`

Verify the CHARACTERS: section appears in buildEnhancedShotImagePrompt.
  </verify>
  <done>
Character descriptions from Scene Memory included in shot prompts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Location Bible integration (Layer 3)</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
In buildEnhancedShotImagePrompt(), after the Character Bible section, add Location Bible integration:

```php
// 1.6. LOCATION BIBLE (Location for this scene) - from buildScenePrompt Layer 3
if ($this->sceneMemory['locationBible']['enabled'] ?? false) {
    $locations = $this->sceneMemory['locationBible']['locations'] ?? [];
    $sceneLocation = $this->getLocationForSceneIndex($locations, $sceneIndex);

    if ($sceneLocation) {
        $locationParts = [];

        $locName = $sceneLocation['name'] ?? '';
        $locType = $sceneLocation['type'] ?? '';
        if ($locName) {
            $locationParts[] = $locName . ($locType ? " ({$locType})" : '');
        }

        if (!empty($sceneLocation['description'])) {
            $locationParts[] = $sceneLocation['description'];
        }

        if (!empty($sceneLocation['timeOfDay'])) {
            $locationParts[] = $sceneLocation['timeOfDay'];
        }

        if (!empty($sceneLocation['weather']) && $sceneLocation['weather'] !== 'clear') {
            $locationParts[] = $sceneLocation['weather'] . ' weather';
        }

        // Include location state for this scene if available
        $locationState = $this->getLocationStateForScene($sceneLocation, $sceneIndex);
        if ($locationState) {
            $locationParts[] = 'current state: ' . $locationState;
        }

        if (!empty($locationParts)) {
            $parts[] = 'LOCATION: ' . implode(', ', $locationParts);
        }
    }
}
```

This is copied directly from buildScenePrompt() lines 11222-11256 for consistency.
  </action>
  <verify>
Run: `grep -B2 -A10 "LOCATION BIBLE" modules/AppVideoWizard/app/Livewire/VideoWizard.php | head -40`

Verify LOCATION: section appears in buildEnhancedShotImagePrompt, separate from the one in buildScenePrompt.
  </verify>
  <done>
Location details from Scene Memory included in shot prompts. PPL-01 and PPL-02 complete.
  </done>
</task>

</tasks>

<verification>
1. buildEnhancedShotImagePrompt has sceneIndex parameter
2. Method contains CHARACTERS: section with character bible lookup
3. Method contains LOCATION: section with location bible lookup
4. No syntax errors (php -l check)
5. Callers updated to pass sceneIndex where available
</verification>

<success_criteria>
- PPL-01 complete: Shot prompts include Character DNA
- PPL-02 complete: Shot prompts include Location DNA
- Shot Preview IMAGE PROMPT shows CHARACTERS and LOCATION sections
- Generated images are visually richer and story-specific
</success_criteria>

<output>
After completion, create `.planning/phases/29-prompt-pipeline-integration/29-02-SUMMARY.md`
</output>
