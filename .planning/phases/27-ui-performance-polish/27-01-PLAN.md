---
phase: 27-ui-performance-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php
  - modules/AppVideoWizard/database/seeders/VwSettingSeeder.php
  - modules/AppVideoWizard/database/migrations/2026_01_27_000001_add_hollywood_expansion_setting.php
autonomous: true

must_haves:
  truths:
    - "Identical shot contexts return cached prompts without re-calling LLM"
    - "Hollywood expansion toggle setting exists in database"
    - "When expansion disabled, prompts skip LLM entirely"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php"
      provides: "Caching layer and expansion toggle check"
      contains: "Cache::remember"
    - path: "modules/AppVideoWizard/database/migrations/2026_01_27_000001_add_hollywood_expansion_setting.php"
      provides: "Migration adding hollywood_expansion_enabled setting"
  key_links:
    - from: "StructuredPromptBuilderService::buildHollywoodPrompt()"
      to: "Cache::remember"
      via: "Cache lookup before LLM expansion"
      pattern: "Cache::remember.*prompt_cache"
    - from: "StructuredPromptBuilderService::buildHollywoodPrompt()"
      to: "VwSetting::getValue"
      via: "Check toggle before LLM routing"
      pattern: "VwSetting::getValue.*hollywood_expansion"
---

<objective>
Add prompt caching layer and expansion toggle setting

Purpose: Cache LLM-expanded prompts to avoid re-expanding identical contexts, and add global setting to enable/disable Hollywood expansion
Output: Caching integrated into buildHollywoodPrompt(), VwSetting entry for toggle
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-ui-performance-polish/27-CONTEXT.md
@modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php
@modules/AppVideoWizard/app/Models/VwSetting.php
@modules/AppVideoWizard/database/seeders/VwSettingSeeder.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add caching to buildHollywoodPrompt()</name>
  <files>modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php</files>
  <action>
Add caching to buildHollywoodPrompt() method:

1. Add `use Illuminate\Support\Facades\Cache;` import at top of file

2. At the START of buildHollywoodPrompt(), add cache lookup:
```php
// Generate cache key from shot data
$cacheKey = $this->generatePromptCacheKey($options);

// Check cache first (only for LLM-eligible shots)
if ($this->shouldUseLLMExpansion($options)) {
    $cached = Cache::get($cacheKey);
    if ($cached !== null) {
        Log::debug('StructuredPromptBuilder: Cache hit for prompt', [
            'cache_key' => $cacheKey,
        ]);
        return $cached;
    }
}
```

3. Add cache store AFTER successful LLM expansion (around line 706, after wrapLLMResult):
```php
// Cache the LLM result for 24 hours
Cache::put($cacheKey, $result, now()->addHours(24));
Log::debug('StructuredPromptBuilder: Cached LLM-expanded prompt', [
    'cache_key' => $cacheKey,
    'ttl_hours' => 24,
]);
return $result;
```

4. Add private helper method after buildHollywoodPrompt():
```php
/**
 * Generate cache key for prompt based on shot data and Bible context.
 *
 * @param array $options Shot configuration options
 * @return string Cache key
 */
private function generatePromptCacheKey(array $options): string
{
    // Include all data that affects prompt generation
    $keyData = [
        'shot_type' => $options['shot_type'] ?? 'medium',
        'character' => $options['character'] ?? null,
        'emotion' => $options['emotion'] ?? null,
        'subtext' => $options['subtext'] ?? null,
        'environment' => $options['environment'] ?? null,
        'visual_mode' => $options['visual_mode'] ?? 'cinematic-realistic',
        'scene_description' => $options['scene_description'] ?? null,
        'character_bible' => $options['character_bible'] ?? null,
        'location_bible' => $options['location_bible'] ?? null,
    ];

    return 'prompt_cache:' . md5(json_encode($keyData));
}
```

Do NOT cache template-only results (they're fast enough).
  </action>
  <verify>
Grep for:
- `Cache::get($cacheKey)` in buildHollywoodPrompt()
- `Cache::put($cacheKey` after wrapLLMResult
- `function generatePromptCacheKey` method exists
  </verify>
  <done>
- Cache lookup happens before LLM expansion
- Cache store happens after successful LLM expansion
- Cache key includes all relevant shot data
- Template-only results are NOT cached
  </done>
</task>

<task type="auto">
  <name>Task 2: Add expansion toggle setting and check</name>
  <files>
    modules/AppVideoWizard/database/seeders/VwSettingSeeder.php
    modules/AppVideoWizard/database/migrations/2026_01_27_000001_add_hollywood_expansion_setting.php
    modules/AppVideoWizard/app/Services/StructuredPromptBuilderService.php
  </files>
  <action>
1. Create migration file `modules/AppVideoWizard/database/migrations/2026_01_27_000001_add_hollywood_expansion_setting.php`:
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Modules\AppVideoWizard\Models\VwSetting;

return new class extends Migration
{
    public function up(): void
    {
        VwSetting::create([
            'slug' => 'hollywood_expansion_enabled',
            'name' => 'Hollywood Prompt Expansion',
            'category' => 'production_intelligence',
            'description' => 'Enable AI-enhanced prompts for complex shots. When enabled, shots with multiple characters, unusual settings, or high emotional complexity automatically route to LLM expansion for Hollywood-quality prompts.',
            'value_type' => 'boolean',
            'value' => 'true',
            'default_value' => 'true',
            'input_type' => 'checkbox',
            'input_help' => 'Disable for faster generation with template-only prompts',
            'icon' => 'fa-solid fa-wand-magic-sparkles',
            'is_system' => false,
            'is_active' => true,
            'sort_order' => 1,
        ]);
    }

    public function down(): void
    {
        VwSetting::where('slug', 'hollywood_expansion_enabled')->delete();
    }
};
```

2. Add same setting entry to VwSettingSeeder.php in the production_intelligence section (after the existing entries, around line 136):
```php
// Hollywood Expansion Toggle
[
    'slug' => 'hollywood_expansion_enabled',
    'name' => 'Hollywood Prompt Expansion',
    'category' => 'production_intelligence',
    'description' => 'Enable AI-enhanced prompts for complex shots. When enabled, shots with multiple characters, unusual settings, or high emotional complexity automatically route to LLM expansion for Hollywood-quality prompts.',
    'value_type' => 'boolean',
    'value' => 'true',
    'default_value' => 'true',
    'input_type' => 'checkbox',
    'input_help' => 'Disable for faster generation with template-only prompts',
    'icon' => 'fa-solid fa-wand-magic-sparkles',
    'is_system' => false,
    'sort_order' => 1,
],
```

3. In StructuredPromptBuilderService.php, add expansion toggle check at the START of shouldUseLLMExpansion() method (find this method and add at the beginning):
```php
// Check global toggle first
if (!VwSetting::getValue('hollywood_expansion_enabled', true)) {
    return false;
}
```

Also add the import at top: `use Modules\AppVideoWizard\Models\VwSetting;`
  </action>
  <verify>
- Migration file exists with VwSetting::create for hollywood_expansion_enabled
- VwSettingSeeder.php contains hollywood_expansion_enabled entry
- shouldUseLLMExpansion() checks VwSetting::getValue('hollywood_expansion_enabled') at start
- VwSetting import added to StructuredPromptBuilderService.php
  </verify>
  <done>
- Setting exists in database (via migration and seeder)
- Setting defaults to true (expansion enabled)
- When false, shouldUseLLMExpansion() immediately returns false
- All shots skip LLM and use template-only path when disabled
  </done>
</task>

</tasks>

<verification>
1. Grep confirms Cache import and usage in StructuredPromptBuilderService
2. Migration file exists with correct VwSetting entry
3. Seeder contains hollywood_expansion_enabled setting
4. shouldUseLLMExpansion() has toggle check at start
</verification>

<success_criteria>
- Prompt caching layer added to buildHollywoodPrompt()
- Cache key uses MD5 of shot data + Bible context
- Cache TTL is 24 hours
- Hollywood expansion toggle setting exists
- Toggle check prevents LLM routing when disabled
- Template-only results are NOT cached (fast enough)
</success_criteria>

<output>
After completion, create `.planning/phases/27-ui-performance-polish/27-01-SUMMARY.md`
</output>
