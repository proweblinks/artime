---
phase: 27-ui-performance-polish
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - modules/AppVideoWizard/resources/views/livewire/partials/prompt-comparison.blade.php
  - modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Users can see expanded prompt in shot cards by default"
    - "Users can toggle to see original brief prompt alongside expanded"
    - "Word count difference is visible (words, chars, tokens)"
    - "Responsive layout: side-by-side on wide screens, stacked on narrow"
  artifacts:
    - path: "modules/AppVideoWizard/resources/views/livewire/partials/prompt-comparison.blade.php"
      provides: "Prompt comparison accordion component"
      min_lines: 50
    - path: "modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php"
      provides: "Integration of comparison component in shot cards"
      contains: "prompt-comparison"
  key_links:
    - from: "storyboard.blade.php"
      to: "partials/prompt-comparison.blade.php"
      via: "@include directive"
      pattern: "@include.*prompt-comparison"
    - from: "prompt-comparison.blade.php"
      to: "Alpine.js x-data"
      via: "Toggle state management"
      pattern: "x-data.*showOriginal"
---

<objective>
Create prompt comparison UI component for storyboard shot cards

Purpose: Let users see before/after prompt expansion with word count difference visible
Output: Blade partial for prompt comparison, integrated into storyboard shot cards
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-ui-performance-polish/27-CONTEXT.md
@modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt comparison Blade partial</name>
  <files>modules/AppVideoWizard/resources/views/livewire/partials/prompt-comparison.blade.php</files>
  <action>
Create new file `modules/AppVideoWizard/resources/views/livewire/partials/prompt-comparison.blade.php`:

```blade
{{-- Prompt Comparison Component
     Shows expanded Hollywood prompt by default, with toggle to reveal original.
     Responsive: side-by-side on wide screens (>1200px), stacked on narrow.

     Expected variables:
     - $originalPrompt: string - Brief original prompt
     - $expandedPrompt: string - Hollywood-quality expanded prompt
     - $expansionMethod: string - 'llm' or 'template'
--}}

@php
    // Calculate word counts
    $originalWords = str_word_count($originalPrompt ?? '');
    $expandedWords = str_word_count($expandedPrompt ?? '');

    // Calculate character counts
    $originalChars = strlen($originalPrompt ?? '');
    $expandedChars = strlen($expandedPrompt ?? '');

    // Estimate tokens (rough: words * 1.3)
    $originalTokens = round($originalWords * 1.3);
    $expandedTokens = round($expandedWords * 1.3);

    // Expansion ratio
    $expansionRatio = $originalWords > 0 ? round($expandedWords / $originalWords, 1) : 0;
@endphp

<div class="vw-prompt-comparison" x-data="{ showOriginal: false }">
    {{-- Word Count Badge --}}
    <div class="vw-prompt-stats">
        <span class="vw-prompt-stat">
            <span class="vw-prompt-stat-label">{{ __('Words') }}</span>
            <span class="vw-prompt-stat-value">{{ $originalWords }} &rarr; {{ $expandedWords }}</span>
        </span>
        <span class="vw-prompt-stat">
            <span class="vw-prompt-stat-label">{{ __('Chars') }}</span>
            <span class="vw-prompt-stat-value">{{ number_format($originalChars) }} &rarr; {{ number_format($expandedChars) }}</span>
        </span>
        <span class="vw-prompt-stat">
            <span class="vw-prompt-stat-label">{{ __('Tokens') }}</span>
            <span class="vw-prompt-stat-value">~{{ $originalTokens }} &rarr; ~{{ $expandedTokens }}</span>
        </span>
        @if($expansionRatio > 1)
            <span class="vw-prompt-expansion-badge" title="{{ __('Expansion ratio') }}">
                {{ $expansionRatio }}x
            </span>
        @endif
        @if($expansionMethod === 'llm')
            <span class="vw-prompt-method-badge vw-prompt-method-llm" title="{{ __('LLM-expanded') }}">
                <i class="fa-solid fa-wand-magic-sparkles"></i> {{ __('AI') }}
            </span>
        @else
            <span class="vw-prompt-method-badge vw-prompt-method-template" title="{{ __('Template-expanded') }}">
                <i class="fa-solid fa-file-lines"></i> {{ __('Template') }}
            </span>
        @endif
    </div>

    {{-- Toggle Button --}}
    <button type="button"
            class="vw-prompt-toggle"
            @click="showOriginal = !showOriginal"
            :class="{ 'active': showOriginal }">
        <i class="fa-solid" :class="showOriginal ? 'fa-eye-slash' : 'fa-eye'"></i>
        <span x-text="showOriginal ? '{{ __('Hide original') }}' : '{{ __('Show original') }}'"></span>
    </button>

    {{-- Prompt Display Area --}}
    <div class="vw-prompt-display" :class="{ 'comparison-mode': showOriginal }">
        {{-- Expanded Prompt (always visible) --}}
        <div class="vw-prompt-panel vw-prompt-expanded">
            <div class="vw-prompt-panel-header">
                <span class="vw-prompt-panel-label">{{ __('Hollywood Prompt') }}</span>
            </div>
            <div class="vw-prompt-panel-content">
                {{ $expandedPrompt }}
            </div>
        </div>

        {{-- Original Prompt (visible when toggled) --}}
        <div class="vw-prompt-panel vw-prompt-original" x-show="showOriginal" x-transition.opacity>
            <div class="vw-prompt-panel-header">
                <span class="vw-prompt-panel-label">{{ __('Original') }}</span>
            </div>
            <div class="vw-prompt-panel-content">
                {{ $originalPrompt }}
            </div>
        </div>
    </div>
</div>

<style>
    .vw-prompt-comparison {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        padding: 0.75rem;
    }

    .vw-prompt-stats {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 0.5rem;
    }

    .vw-prompt-stat {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.65rem;
    }

    .vw-prompt-stat-label {
        color: rgba(255, 255, 255, 0.4);
    }

    .vw-prompt-stat-value {
        color: rgba(255, 255, 255, 0.7);
        font-family: monospace;
    }

    .vw-prompt-expansion-badge {
        padding: 0.15rem 0.4rem;
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        border-radius: 0.25rem;
        font-size: 0.6rem;
        font-weight: 600;
    }

    .vw-prompt-method-badge {
        padding: 0.15rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.6rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .vw-prompt-method-llm {
        background: rgba(139, 92, 246, 0.15);
        color: #a78bfa;
    }

    .vw-prompt-method-template {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
    }

    .vw-prompt-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.6rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.3rem;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.15s ease;
        margin-bottom: 0.5rem;
    }

    .vw-prompt-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
    }

    .vw-prompt-toggle.active {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.3);
        color: #a78bfa;
    }

    .vw-prompt-display {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    /* Responsive side-by-side layout */
    @media (min-width: 1200px) {
        .vw-prompt-display.comparison-mode {
            flex-direction: row;
        }

        .vw-prompt-display.comparison-mode .vw-prompt-panel {
            flex: 1;
        }
    }

    .vw-prompt-panel {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 0.4rem;
        overflow: hidden;
    }

    .vw-prompt-panel-header {
        padding: 0.35rem 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .vw-prompt-panel-label {
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 600;
    }

    .vw-prompt-panel-content {
        padding: 0.5rem;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
        max-height: 150px;
        overflow-y: auto;
    }

    .vw-prompt-expanded .vw-prompt-panel-label {
        color: rgba(139, 92, 246, 0.7);
    }

    .vw-prompt-original .vw-prompt-panel-label {
        color: rgba(251, 146, 60, 0.7);
    }

    .vw-prompt-original {
        border-color: rgba(251, 146, 60, 0.15);
    }
</style>
```
  </action>
  <verify>
File exists at `modules/AppVideoWizard/resources/views/livewire/partials/prompt-comparison.blade.php` with:
- Word/char/token count display
- Toggle button with Alpine.js
- Responsive CSS (side-by-side on >1200px)
- Both original and expanded prompt panels
  </verify>
  <done>
- Component shows expanded prompt by default
- Toggle reveals original prompt
- Word count badge shows: words -> words | chars -> chars | ~tokens -> ~tokens
- Expansion method badge (AI or Template)
- Responsive: side-by-side on wide, stacked on narrow
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate comparison component into storyboard shot cards</name>
  <files>
    modules/AppVideoWizard/resources/views/livewire/steps/storyboard.blade.php
    modules/AppVideoWizard/app/Livewire/VideoWizard.php
  </files>
  <action>
1. In storyboard.blade.php, find the "Prompt Section - Compact" around line 6285-6301 and REPLACE it with the comparison component include:

FIND this block (approximately lines 6285-6301):
```blade
                    {{-- Prompt Section - Compact --}}
                    <div style="padding: 0.5rem 0.75rem; border-top: 1px solid rgba(255,255,255,0.05);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span style="font-size: 0.6rem; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.5px;">{{ __('PROMPT') }}</span>
                            <div style="display: flex; align-items: center; gap: 0.4rem;">
                                <span style="font-size: 0.65rem; padding: 0.15rem 0.35rem; background: rgba(6,182,212,0.15); color: #67e8f9; border-radius: 0.2rem;">
                                    ⏱️ {{ $scene['duration'] ?? 8 }}s
                                </span>
                                <span style="font-size: 0.65rem; color: rgba(255,255,255,0.4);">
                                    {{ $scene['transition'] ?? 'cut' }}
                                </span>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.65); line-height: 1.4; max-height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                            {{ Str::limit($prompt, 120) }}
                        </div>
                    </div>
```

REPLACE with:
```blade
                    {{-- Prompt Comparison Section --}}
                    @php
                        // Get prompt data for comparison
                        $originalPrompt = $scene['description'] ?? $scene['visual'] ?? $scene['narration'] ?? '';
                        $expandedPrompt = $storyboardScene['expandedPrompt'] ?? $storyboardScene['prompt'] ?? $prompt ?? '';
                        $expansionMethod = $storyboardScene['expansionMethod'] ?? 'template';
                    @endphp
                    @include('appvideowizard::livewire.partials.prompt-comparison', [
                        'originalPrompt' => $originalPrompt,
                        'expandedPrompt' => $expandedPrompt,
                        'expansionMethod' => $expansionMethod,
                    ])
```

2. In VideoWizard.php, find the method that generates/stores prompts (likely in generateImage or buildPromptForScene) and ensure it stores both:
   - `expandedPrompt` - The full Hollywood prompt
   - `expansionMethod` - Either 'llm' or 'template'

Search for where `$storyboardScene['prompt']` is set. Add alongside it:
```php
$storyboardScene['expandedPrompt'] = $result['creative_prompt']['full_prompt'] ?? $result['prompt'] ?? '';
$storyboardScene['expansionMethod'] = $result['llm_metadata']['method'] ?? 'template';
```

The exact location depends on how prompts are generated. Look for:
- `StructuredPromptBuilderService::build()` calls
- Where `$this->storyboard['scenes'][$index]['prompt']` is set
  </action>
  <verify>
- storyboard.blade.php includes prompt-comparison partial
- Include passes originalPrompt, expandedPrompt, expansionMethod
- VideoWizard.php stores expandedPrompt and expansionMethod in storyboard scene data
  </verify>
  <done>
- Shot cards show prompt comparison component instead of truncated text
- Original prompt comes from scene description/visual/narration
- Expanded prompt comes from storyboardScene data
- Expansion method badge shows AI or Template
  </done>
</task>

</tasks>

<verification>
1. Blade partial exists at partials/prompt-comparison.blade.php
2. Storyboard includes the partial with correct variables
3. Shot cards display word count badge and toggle
4. Clicking "Show original" reveals the brief prompt
5. On wide screens (>1200px), side-by-side layout works
</verification>

<success_criteria>
- Prompt comparison component created with accordion pattern
- Word count shows: X -> Y words | X -> Y chars | ~X -> ~Y tokens
- Expansion ratio badge shows (e.g., "12x")
- Method badge shows AI or Template
- Toggle reveals original prompt
- Responsive layout works (side-by-side on wide, stacked on narrow)
- Integrated into storyboard shot cards
</success_criteria>

<output>
After completion, create `.planning/phases/27-ui-performance-polish/27-02-SUMMARY.md`
</output>
