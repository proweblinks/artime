---
phase: 17-voice-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/VoiceRegistryService.php
autonomous: true

must_haves:
  truths:
    - "VoiceRegistryService class exists and can be instantiated"
    - "Registry can be initialized with Character Bible data"
    - "Registry tracks character voices with first-occurrence-wins behavior"
    - "Registry provides narrator and internal voice accessors"
    - "Mismatch detection logs warnings without throwing exceptions"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/VoiceRegistryService.php"
      provides: "Voice tracking service class"
      min_lines: 100
      exports: ["VoiceRegistryService"]
      contains: "class VoiceRegistryService"
  key_links:
    - from: "VoiceRegistryService"
      to: "Illuminate\\Support\\Facades\\Log"
      via: "Log facade import and usage"
      pattern: "use Illuminate\\\\Support\\\\Facades\\\\Log"
---

<objective>
Create the VoiceRegistryService class that serves as the single source of truth for voice assignments.

Purpose: Centralizes voice tracking (VOC-05) so narrator, internal thought, and character voices are managed through one class with first-occurrence-wins behavior and mismatch detection.

Output: `VoiceRegistryService.php` with initialization, registration, lookup, and validation methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-voice-registry/17-CONTEXT.md
@.planning/phases/17-voice-registry/17-RESEARCH.md

# Existing voice lookup methods for reference (wrapper pattern)
@modules/AppVideoWizard/app/Livewire/VideoWizard.php (lines 8598-8766 for getNarratorVoice, getVoiceForCharacterName, validateVoiceContinuity)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VoiceRegistryService class</name>
  <files>modules/AppVideoWizard/app/Services/VoiceRegistryService.php</files>
  <action>
Create `VoiceRegistryService.php` in `modules/AppVideoWizard/app/Services/` with:

**Namespace and imports:**
```php
namespace Modules\AppVideoWizard\Services;
use Illuminate\Support\Facades\Log;
```

**Properties (protected):**
- `array $characterVoices = []` - character name (uppercase key) => `['voiceId' => string, 'source' => string]`
- `?string $narratorVoiceId = null` - narrator voice from getNarratorVoice()
- `?string $internalVoiceId = null` - internal thought voice (typically character's voice)

**Methods:**

1. `initializeFromCharacterBible(array $characterBible, string $narratorVoice): void`
   - Loop through `$characterBible['characters'] ?? []`
   - Extract voice ID handling both formats:
     - New: `$char['voice']['id']` (array format)
     - Legacy: `$char['voice']` (string format)
   - Call `registerCharacterVoice($name, $voiceId, 'character_bible')` for each
   - Set `$this->narratorVoiceId = $narratorVoice`
   - Log::info with count of registered characters

2. `registerCharacterVoice(string $characterName, string $voiceId, string $source): bool` (protected)
   - Normalize key: `$key = strtoupper(trim($characterName))`
   - If already in `$characterVoices`:
     - If voiceId matches: return true (already registered, same voice)
     - If voiceId differs: Log::warning with mismatch details, return false
   - If not registered: add to array, Log::debug, return true

3. `getVoiceForCharacter(string $characterName, callable $fallbackLookup): string`
   - Normalize key
   - If in registry: return `$characterVoices[$key]['voiceId']`
   - Else: call `$fallbackLookup($characterName)`, register result with source 'runtime_lookup', return voice

4. `getNarratorVoice(): string`
   - Return `$this->narratorVoiceId` (no null fallback - must be initialized)

5. `getInternalVoice(?string $voiceId = null): string`
   - If $voiceId provided AND internalVoiceId is null: set internalVoiceId, Log::debug
   - Return `$this->internalVoiceId ?? $this->narratorVoiceId` (fallback to narrator)

6. `getValidationSummary(): array`
   - Return array with: charactersRegistered (count), narratorVoice, internalVoice, characters (array of voiceId/source pairs)

**Doc blocks:** Add class-level doc describing Phase 17 purpose. Add method-level docs with @param and @return.
  </action>
  <verify>
Run: `php -l modules/AppVideoWizard/app/Services/VoiceRegistryService.php` - no syntax errors
Grep: `grep -c "function" modules/AppVideoWizard/app/Services/VoiceRegistryService.php` - returns 6 (6 methods)
Grep: `grep "class VoiceRegistryService" modules/AppVideoWizard/app/Services/VoiceRegistryService.php` - class exists
  </verify>
  <done>
VoiceRegistryService.php exists with all 6 methods, handles both voice formats, logs appropriately, no syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit test scenarios as comments</name>
  <files>modules/AppVideoWizard/app/Services/VoiceRegistryService.php</files>
  <action>
Add a doc block at the end of the class (before closing brace) with test scenarios as comments. This documents expected behavior for future test implementation:

```php
/**
 * Test Scenarios (VOC-05)
 *
 * 1. Initialization from Character Bible (new format):
 *    - Input: ['characters' => [['name' => 'Alice', 'voice' => ['id' => 'nova']]]]
 *    - Expected: getVoiceForCharacter('Alice', fn($n) => 'fallback') returns 'nova'
 *
 * 2. Initialization from Character Bible (legacy format):
 *    - Input: ['characters' => [['name' => 'Bob', 'voice' => 'onyx']]]
 *    - Expected: getVoiceForCharacter('Bob', fn($n) => 'fallback') returns 'onyx'
 *
 * 3. First-occurrence-wins:
 *    - Call getVoiceForCharacter('Charlie', fn($n) => 'alloy')
 *    - Call getVoiceForCharacter('Charlie', fn($n) => 'shimmer')
 *    - Expected: Both return 'alloy' (first wins)
 *
 * 4. Mismatch detection:
 *    - Initialize with Alice => 'nova'
 *    - Call getVoiceForCharacter('Alice', fn($n) => 'echo')
 *    - Expected: Returns 'nova', logs warning about mismatch
 *
 * 5. Case-insensitive matching:
 *    - Initialize with 'HERO' => 'nova'
 *    - Call getVoiceForCharacter('hero', fn($n) => 'fallback')
 *    - Expected: Returns 'nova' (matches regardless of case)
 *
 * 6. Internal voice fallback:
 *    - Initialize with narratorVoice = 'fable', no internalVoice set
 *    - Call getInternalVoice()
 *    - Expected: Returns 'fable' (falls back to narrator)
 */
```

This provides documentation without requiring a full test file, following the codebase pattern.
  </action>
  <verify>
Grep: `grep "Test Scenarios" modules/AppVideoWizard/app/Services/VoiceRegistryService.php` - test documentation exists
  </verify>
  <done>
Test scenarios documented in class, covering all key behaviors
  </done>
</task>

</tasks>

<verification>
1. File exists: `ls modules/AppVideoWizard/app/Services/VoiceRegistryService.php`
2. Syntax valid: `php -l modules/AppVideoWizard/app/Services/VoiceRegistryService.php`
3. All methods present: grep for each method name
4. Correct namespace: grep for `namespace Modules\AppVideoWizard\Services`
5. Log facade imported: grep for `use Illuminate\Support\Facades\Log`
</verification>

<success_criteria>
- VoiceRegistryService.php created in Services directory
- Class has all 6 methods with correct signatures
- Handles both array and string voice formats from Character Bible
- First-occurrence-wins logic implemented in registerCharacterVoice
- Mismatch detection logs warnings but doesn't throw
- Test scenarios documented as comments
- No PHP syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-voice-registry/17-01-SUMMARY.md`
</output>
