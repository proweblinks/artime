---
phase: 17-voice-registry
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Voice registry is initialized at start of decomposeAllScenes()"
    - "Narrator voice lookups use registry instead of direct getNarratorVoice()"
    - "Internal thought voice lookups use registry"
    - "Character voice lookups use registry with fallback wrapper"
    - "All voice assignments flow through single source of truth"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Registry integration in decomposition pipeline"
      contains: "VoiceRegistryService"
  key_links:
    - from: "decomposeAllScenes()"
      to: "VoiceRegistryService::initializeFromCharacterBible"
      via: "instantiation and initialization call"
      pattern: "new VoiceRegistryService"
    - from: "overlayNarratorSegments()"
      to: "VoiceRegistryService::getNarratorVoice"
      via: "registry narrator lookup"
      pattern: "voiceRegistry->getNarratorVoice"
    - from: "markInternalThoughtAsVoiceover()"
      to: "VoiceRegistryService::getVoiceForCharacter"
      via: "registry character lookup with fallback"
      pattern: "voiceRegistry->getVoiceForCharacter"
---

<objective>
Integrate VoiceRegistryService into VideoWizard.php decomposition pipeline.

Purpose: Wire the registry created in 17-01 into the actual voice lookup calls so all voice assignments flow through a single source of truth (VOC-05 requirement).

Output: VideoWizard.php modified with registry property, initialization in decomposeAllScenes(), and registry calls in overlayNarratorSegments() and markInternalThoughtAsVoiceover().
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-voice-registry/17-CONTEXT.md
@.planning/phases/17-voice-registry/17-RESEARCH.md
@.planning/phases/17-voice-registry/17-01-SUMMARY.md

# Source file to modify
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
@modules/AppVideoWizard/app/Services/VoiceRegistryService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add registry property and import</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
1. **Add use statement** at top of file with other Service imports (around line 20-30):
```php
use Modules\AppVideoWizard\Services\VoiceRegistryService;
```

2. **Add property** to the VideoWizard class (in properties section, around line 100-150 with other protected properties):
```php
/**
 * Voice registry service for centralized voice assignment tracking (Phase 17).
 * Initialized at start of decomposeAllScenes().
 */
protected ?VoiceRegistryService $voiceRegistry = null;
```

Search for existing properties like `protected ?CharacterLookService` or similar service properties to find the right location.
  </action>
  <verify>
Grep: `grep "use Modules\\\\AppVideoWizard\\\\Services\\\\VoiceRegistryService" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - import exists
Grep: `grep "protected ?VoiceRegistryService" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - property exists
  </verify>
  <done>
VoiceRegistryService imported and $voiceRegistry property declared
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize registry in decomposeAllScenes()</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Modify `decomposeAllScenes()` (around line 24723) to initialize the registry at the start of the try block, BEFORE the foreach loop:

**Current code (lines 24731-24733):**
```php
try {
    foreach ($this->script['scenes'] as $index => $scene) {
```

**Modified code:**
```php
try {
    // Phase 17: Initialize voice registry from Character Bible
    $this->voiceRegistry = new VoiceRegistryService();
    $this->voiceRegistry->initializeFromCharacterBible(
        $this->sceneMemory['characterBible'] ?? [],
        $this->getNarratorVoice()
    );

    foreach ($this->script['scenes'] as $index => $scene) {
```

This ensures registry is populated BEFORE any scene decomposition begins, so all voice lookups have access to registered voices.
  </action>
  <verify>
Grep: `grep -A 5 "try {" modules/AppVideoWizard/app/Livewire/VideoWizard.php | grep -A 5 "decomposeAllScenes" | grep "VoiceRegistryService"` - initialization present
Manual check: Read decomposeAllScenes() method and verify registry initialization is first action in try block
  </verify>
  <done>
Registry initialized at start of decomposeAllScenes() with Character Bible data and narrator voice
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire registry into voice lookups</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Update three voice lookup locations to use the registry:

**1. overlayNarratorSegments() - line 24143:**
```php
// Before:
$shots[$shotIdx]['narratorVoiceId'] = $this->getNarratorVoice(); // VOC-01: narrator voice assignment

// After:
$shots[$shotIdx]['narratorVoiceId'] = $this->voiceRegistry
    ? $this->voiceRegistry->getNarratorVoice()
    : $this->getNarratorVoice(); // VOC-01/VOC-05: narrator voice via registry
```

**2. markInternalThoughtAsVoiceover() - line 24307:**
```php
// Before:
$voiceId = $speaker ? $this->getVoiceForCharacterName($speaker) : $this->getNarratorVoice();

// After:
$voiceId = $speaker
    ? ($this->voiceRegistry
        ? $this->voiceRegistry->getVoiceForCharacter($speaker, fn($name) => $this->getVoiceForCharacterName($name))
        : $this->getVoiceForCharacterName($speaker))
    : ($this->voiceRegistry
        ? $this->voiceRegistry->getNarratorVoice()
        : $this->getNarratorVoice()); // VOC-05: voice via registry
```

**3. Character config generation - line 24697:**
```php
// Before:
'voiceId' => $char['voice']['id'] ?? $this->getVoiceForCharacterName($char['name'] ?? ''),

// After:
'voiceId' => $char['voice']['id'] ?? (
    $this->voiceRegistry
        ? $this->voiceRegistry->getVoiceForCharacter($char['name'] ?? '', fn($name) => $this->getVoiceForCharacterName($name))
        : $this->getVoiceForCharacterName($char['name'] ?? '')
), // VOC-05: voice via registry
```

**IMPORTANT:** Each lookup includes null-check on `$this->voiceRegistry` for safety - if registry not initialized (edge case), falls back to original method. This preserves backward compatibility.
  </action>
  <verify>
Grep: `grep "voiceRegistry->getNarratorVoice" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - narrator lookups wired
Grep: `grep "voiceRegistry->getVoiceForCharacter" modules/AppVideoWizard/app/Livewire/VideoWizard.php` - character lookups wired
Run: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php` - no syntax errors
  </verify>
  <done>
All three voice lookup locations updated to use registry with fallback safety
  </done>
</task>

</tasks>

<verification>
1. Syntax valid: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Import added: grep for VoiceRegistryService use statement
3. Property added: grep for `$voiceRegistry` property declaration
4. Initialization added: grep for `new VoiceRegistryService()` in decomposeAllScenes
5. Narrator lookup wired: grep for `voiceRegistry->getNarratorVoice`
6. Character lookup wired: grep for `voiceRegistry->getVoiceForCharacter`
7. No broken tests: If test suite exists, run it
</verification>

<success_criteria>
- VoiceRegistryService imported at top of file
- $voiceRegistry property declared on VideoWizard class
- Registry initialized in decomposeAllScenes() before scene loop
- overlayNarratorSegments() uses registry for narrator voice
- markInternalThoughtAsVoiceover() uses registry for character/narrator voice
- Character config generation uses registry for voice lookup
- All lookups have null-check fallback for backward compatibility
- No PHP syntax errors
- VOC-05 requirement satisfied: single source of truth for voice assignments
</success_criteria>

<output>
After completion, create `.planning/phases/17-voice-registry/17-02-SUMMARY.md`
</output>
