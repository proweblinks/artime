---
phase: 28-voice-production-excellence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/resources/views/livewire/modals/character-bible.blade.php
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "User can preview voice with emotion applied"
    - "Emotion dropdown shows available emotions from VoiceDirectionVocabulary"
    - "Preview button plays voice sample with selected emotion"
  artifacts:
    - path: "modules/AppVideoWizard/resources/views/livewire/modals/character-bible.blade.php"
      provides: "Emotion preview dropdown and button in voice section"
      contains: "previewEmotion"
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "previewVoiceWithEmotion method"
      exports: ["previewVoiceWithEmotion"]
  key_links:
    - from: "character-bible.blade.php"
      to: "VideoWizard.php"
      via: "wire:click previewVoiceWithEmotion"
      pattern: "wire:click.*previewVoiceWithEmotion"
    - from: "VideoWizard.php"
      to: "VoicePromptBuilderService"
      via: "buildEnhancedVoicePrompt call"
      pattern: "buildEnhancedVoicePrompt"
---

<objective>
Add emotion preview capability to Character Bible voice section.

Purpose: VOC-12 enhances the existing voice selection UI with emotion preview. Users can hear
how a character voice sounds with different emotional directions (trembling, whisper, etc.)
before finalizing their selection.

Output: Emotion dropdown in Character Bible modal, previewVoiceWithEmotion() method in
VideoWizard that integrates VoicePromptBuilderService.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-voice-production-excellence/28-RESEARCH.md

# Key files
@modules/AppVideoWizard/resources/views/livewire/modals/character-bible.blade.php
@modules/AppVideoWizard/app/Services/VoiceDirectionVocabulary.php
@modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add previewVoiceWithEmotion method to VideoWizard</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a new public method to VideoWizard for emotion-enhanced voice preview:

1. Add property for storing preview emotion (near other character-related properties):
```php
public ?string $previewEmotion = null;
```

2. Add the preview method:
```php
/**
 * Preview character voice with emotional direction applied (VOC-12).
 *
 * @param int $characterIndex Character index in characterBible
 * @param string|null $emotion Emotion to apply (from VoiceDirectionVocabulary)
 */
public function previewVoiceWithEmotion(int $characterIndex, ?string $emotion = null): void
{
    $character = $this->sceneMemory['characterBible']['characters'][$characterIndex] ?? null;
    if (!$character) {
        $this->error = __('Character not found');
        return;
    }

    $voiceId = $character['voice']['id'] ?? $this->getDefaultVoiceForCharacter($character);
    $sampleText = __('Hello, this is how I sound with :emotion emotion.', [
        'emotion' => $emotion ?: 'neutral'
    ]);

    try {
        // Apply emotional direction if specified
        if ($emotion) {
            $promptBuilder = app(\Modules\AppVideoWizard\Services\VoicePromptBuilderService::class);
            $segment = new \Modules\AppVideoWizard\Services\SpeechSegment([
                'text' => $sampleText,
                'emotion' => $emotion,
                'type' => \Modules\AppVideoWizard\Services\SpeechSegment::TYPE_DIALOGUE,
            ]);

            $enhanced = $promptBuilder->buildEnhancedVoicePrompt($segment, [
                'provider' => $this->voiceoverService->getActiveProvider(),
            ]);

            $sampleText = $enhanced['text'];
        }

        $audioData = $this->voiceoverService->previewVoice($voiceId, $sampleText);
        $this->dispatch('play-audio-preview', audioData: $audioData);

    } catch (\Exception $e) {
        \Log::error('Voice preview with emotion failed (VOC-12)', [
            'character' => $character['name'] ?? 'unknown',
            'emotion' => $emotion,
            'error' => $e->getMessage(),
        ]);
        $this->error = __('Failed to preview voice: :error', ['error' => $e->getMessage()]);
    }
}
```

3. If getDefaultVoiceForCharacter doesn't exist, add helper:
```php
protected function getDefaultVoiceForCharacter(array $character): string
{
    $gender = strtolower($character['gender'] ?? $character['voice']['gender'] ?? '');
    if (str_contains($gender, 'female')) return 'nova';
    if (str_contains($gender, 'male')) return 'onyx';
    return 'alloy';
}
```
  </action>
  <verify>
Run: `php artisan tinker --execute="method_exists(\Modules\AppVideoWizard\Livewire\VideoWizard::class, 'previewVoiceWithEmotion')"`
Should return true.
  </verify>
  <done>VideoWizard has previewVoiceWithEmotion method that uses VoicePromptBuilderService.</done>
</task>

<task type="auto">
  <name>Task 2: Add emotion preview UI to Character Bible modal</name>
  <files>modules/AppVideoWizard/resources/views/livewire/modals/character-bible.blade.php</files>
  <action>
Locate the Character Voice section (around line 440-580, inside the voiceOpen collapse).

After the Speed Slider section (around line 549), add emotion preview controls:

```blade
{{-- Emotion Preview (VOC-12) --}}
<div style="margin-bottom: 0.35rem; padding-top: 0.3rem; border-top: 1px solid rgba(255,255,255,0.1);">
    <label style="display: block; color: rgba(255,255,255,0.6); font-size: 0.5rem; margin-bottom: 0.15rem;">{{ __('Emotion Preview') }}</label>
    <div style="display: flex; gap: 0.3rem; align-items: center;">
        <select wire:model="previewEmotion"
                style="flex: 1; padding: 0.25rem 0.35rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 0.25rem; color: white; font-size: 0.55rem;">
            <option value="">{{ __('Neutral') }}</option>
            <option value="trembling">{{ __('Trembling') }}</option>
            <option value="whisper">{{ __('Whisper') }}</option>
            <option value="cracking">{{ __('Cracking') }}</option>
            <option value="grief">{{ __('Grief') }}</option>
            <option value="anxiety">{{ __('Anxiety') }}</option>
            <option value="fear">{{ __('Fear') }}</option>
            <option value="contempt">{{ __('Contempt') }}</option>
            <option value="joy">{{ __('Joy') }}</option>
            <option value="disgust">{{ __('Disgust') }}</option>
            <option value="rage">{{ __('Rage') }}</option>
        </select>
        <button type="button"
                wire:click="previewVoiceWithEmotion({{ $editIndex }}, $wire.previewEmotion)"
                wire:loading.attr="disabled"
                wire:target="previewVoiceWithEmotion"
                style="padding: 0.25rem 0.5rem; background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(16,185,129,0.3)); border: 1px solid rgba(139,92,246,0.4); border-radius: 0.25rem; color: #c4b5fd; font-size: 0.55rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.2rem;">
            <span wire:loading.remove wire:target="previewVoiceWithEmotion">{{ __('Preview') }}</span>
            <span wire:loading wire:target="previewVoiceWithEmotion">...</span>
        </button>
    </div>
    <p style="color: rgba(255,255,255,0.4); font-size: 0.4rem; margin-top: 0.15rem;">
        {{ __('Hear how this voice sounds with emotional direction') }}
    </p>
</div>
```

Place this BEFORE the "Speaking Role & Narrator" section (before line 551).
Match existing styling patterns (rgba colors, font-sizes, margin/padding).
  </action>
  <verify>
1. Open Character Bible modal in wizard
2. Expand the Character Voice section
3. Verify emotion preview dropdown appears with options
4. Verify Preview button is visible
5. Click preview with an emotion selected
6. Audio should play (or loading indicator should appear)
  </verify>
  <done>Character Bible modal has emotion preview dropdown and button.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Open wizard, go to Character Bible
2. Create or edit a character
3. Expand Character Voice section
4. Select a voice (e.g., Nova)
5. Select emotion (e.g., Trembling)
6. Click Preview button
7. Should hear voice sample with emotional quality
8. Try different emotions, verify each sounds different
</verification>

<success_criteria>
- [ ] Emotion preview dropdown shows in Character Bible voice section
- [ ] Preview button triggers previewVoiceWithEmotion method
- [ ] Audio preview plays with emotional direction applied
- [ ] Loading state shows while generating preview
- [ ] Errors display gracefully (not silent failure)
</success_criteria>

<output>
After completion, create `.planning/phases/28-voice-production-excellence/28-02-SUMMARY.md`
</output>
