---
phase: 28-voice-production-excellence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/VoiceRegistryService.php
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
autonomous: true

must_haves:
  truths:
    - "Voice selections persist across wizard reload"
    - "Character-voice mappings stored in Scene DNA"
    - "Registry initializes from persisted data on load"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/VoiceRegistryService.php"
      provides: "toArray() and fromArray() methods for serialization"
      exports: ["toArray", "fromArray"]
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "voiceRegistry field in sceneDNA structure"
      contains: "voiceRegistry"
  key_links:
    - from: "VideoWizard.php"
      to: "VoiceRegistryService"
      via: "buildSceneDNA includes voice registry snapshot"
      pattern: "voiceRegistry.*buildVoiceRegistryForDNA"
    - from: "VoiceRegistryService"
      to: "sceneMemory.sceneDNA"
      via: "toArray serialization"
      pattern: "toArray\\(\\)"
---

<objective>
Persist voice registry to Scene DNA so character-voice mappings survive wizard reload.

Purpose: VOC-07 requires voice selections to persist across scenes. Currently VoiceRegistryService
is session-only (instantiated fresh each request). This plan adds serialization methods and
integrates with Scene DNA persistence.

Output: VoiceRegistryService with toArray/fromArray methods, VideoWizard.buildSceneDNA includes
voice registry snapshot, loadSceneMemory restores registry from DNA.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-voice-production-excellence/28-RESEARCH.md

# Key files to reference
@modules/AppVideoWizard/app/Services/VoiceRegistryService.php
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add serialization methods to VoiceRegistryService</name>
  <files>modules/AppVideoWizard/app/Services/VoiceRegistryService.php</files>
  <action>
Add two methods to VoiceRegistryService for serialization:

1. `toArray(): array` - Export registry state for persistence:
```php
public function toArray(): array
{
    return [
        'characterVoices' => $this->characterVoices,
        'narratorVoiceId' => $this->narratorVoiceId,
        'internalVoiceId' => $this->internalVoiceId,
        'lastValidatedAt' => now()->toIso8601String(),
    ];
}
```

2. `fromArray(array $data): void` - Restore registry state:
```php
public function fromArray(array $data): void
{
    $this->characterVoices = $data['characterVoices'] ?? [];
    $this->narratorVoiceId = $data['narratorVoiceId'] ?? null;
    $this->internalVoiceId = $data['internalVoiceId'] ?? null;

    Log::debug('VoiceRegistry restored from persisted data (VOC-07)', [
        'charactersRestored' => count($this->characterVoices),
        'narratorVoice' => $this->narratorVoiceId,
    ]);
}
```

Add logging to track persistence. Do NOT modify existing methods.
  </action>
  <verify>
Run: `php artisan tinker --execute="$r = new \Modules\AppVideoWizard\Services\VoiceRegistryService(); \$r->initializeFromCharacterBible(['characters' => [['name' => 'Alice', 'voice' => ['id' => 'nova']]]], 'fable'); print_r(\$r->toArray());"`
Should output array with characterVoices containing ALICE => nova.
  </verify>
  <done>VoiceRegistryService can export and import its state via toArray/fromArray.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate voice registry into Scene DNA persistence</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Locate the buildSceneDNA() method (or equivalent method that builds the sceneDNA array).

Add voice registry snapshot to the DNA structure:

1. Find where sceneDNA is built (likely in a method like `buildSceneDNA()` or within scene generation).

2. Add helper method `buildVoiceRegistryForDNA()`:
```php
protected function buildVoiceRegistryForDNA(): array
{
    $characterBible = $this->sceneMemory['characterBible'] ?? [];
    $registry = app(\Modules\AppVideoWizard\Services\VoiceRegistryService::class);
    $registry->initializeFromCharacterBible($characterBible, $this->getNarratorVoice());
    return $registry->toArray();
}
```

3. Include in sceneDNA structure:
```php
$sceneDNA['voiceRegistry'] = $this->buildVoiceRegistryForDNA();
```

4. On load (in mount() or loadSceneMemory()), restore registry if persisted:
```php
if (!empty($this->sceneMemory['sceneDNA']['voiceRegistry'])) {
    $registry = app(\Modules\AppVideoWizard\Services\VoiceRegistryService::class);
    $registry->fromArray($this->sceneMemory['sceneDNA']['voiceRegistry']);
}
```

Search for existing sceneDNA patterns in the file to match coding style.
  </action>
  <verify>
1. Create a wizard project, add character with voice selection
2. Generate scene DNA (trigger buildSceneDNA)
3. Check that sceneDNA contains voiceRegistry key with character data
4. Reload the wizard page
5. Verify character voice is still selected (not reset to default)
  </verify>
  <done>Voice registry persists in Scene DNA and restores on wizard load.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Create new project with 2 characters (Alice with nova voice, Bob with onyx voice)
2. Generate Scene DNA
3. Close browser tab, reopen wizard
4. Verify Alice still has nova, Bob still has onyx (not auto-assigned)
5. Check browser DevTools Network tab - sceneMemory should contain voiceRegistry
</verification>

<success_criteria>
- [ ] VoiceRegistryService.toArray() exports all voice mappings
- [ ] VoiceRegistryService.fromArray() restores state correctly
- [ ] Scene DNA includes voiceRegistry snapshot
- [ ] Voice selections survive browser refresh
- [ ] No regression in existing voice functionality
</success_criteria>

<output>
After completion, create `.planning/phases/28-voice-production-excellence/28-01-SUMMARY.md`
</output>
