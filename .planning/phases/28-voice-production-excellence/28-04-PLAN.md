---
phase: 28-voice-production-excellence
plan: 04
type: execute
wave: 2
depends_on: [28-01]
files_modified:
  - modules/AppVideoWizard/app/Services/VoiceoverService.php
autonomous: true

must_haves:
  truths:
    - "Emotional direction tags appear in TTS requests"
    - "VoicePromptBuilderService called before TTS generation"
    - "Provider-specific formatting applied (ElevenLabs inline, OpenAI instructions)"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/VoiceoverService.php"
      provides: "Enhanced TTS with emotional direction"
      contains: "VoicePromptBuilderService"
  key_links:
    - from: "VoiceoverService.generateSceneVoiceover"
      to: "VoicePromptBuilderService.buildEnhancedVoicePrompt"
      via: "Method call before AI::process"
      pattern: "buildEnhancedVoicePrompt"
    - from: "VoiceoverService.generateSegmentedAudio"
      to: "VoicePromptBuilderService"
      via: "Segment enhancement"
      pattern: "buildEnhancedVoicePrompt"
---

<objective>
Integrate VoicePromptBuilderService into VoiceoverService for emotional direction.

Purpose: VOC-09 and VOC-11 require that the Phase 25 VoicePromptBuilderService actually
flows through to TTS generation. Currently it's orphaned (built but not used).
This plan wires it into the TTS pipeline.

Output: VoiceoverService calls VoicePromptBuilderService before TTS generation,
applying emotional tags appropriate for each provider.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-voice-production-excellence/28-RESEARCH.md

# Key files
@modules/AppVideoWizard/app/Services/VoiceoverService.php
@modules/AppVideoWizard/app/Services/VoicePromptBuilderService.php
@modules/AppVideoWizard/app/Services/SpeechSegment.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper method for emotional text enhancement</name>
  <files>modules/AppVideoWizard/app/Services/VoiceoverService.php</files>
  <action>
Add a protected helper method to VoiceoverService that uses VoicePromptBuilderService:

```php
/**
 * Enhance text with emotional direction using VoicePromptBuilderService (VOC-09/VOC-11).
 *
 * @param string $text Text to enhance
 * @param string|null $emotion Emotion to apply
 * @param string $provider TTS provider (openai, kokoro, elevenlabs)
 * @return array{text: string, instructions: string}
 */
protected function enhanceTextWithVoiceDirection(string $text, ?string $emotion, string $provider): array
{
    // Skip if no emotion specified
    if (empty($emotion)) {
        return ['text' => $text, 'instructions' => ''];
    }

    try {
        $segment = new SpeechSegment([
            'text' => $text,
            'emotion' => $emotion,
            'type' => SpeechSegment::TYPE_DIALOGUE,
        ]);

        $promptBuilder = app(VoicePromptBuilderService::class);
        $enhanced = $promptBuilder->buildEnhancedVoicePrompt($segment, [
            'provider' => $provider,
            'includeAmbient' => false,
        ]);

        Log::debug('VoiceoverService: Applied emotional direction (VOC-11)', [
            'emotion' => $emotion,
            'provider' => $provider,
            'hasInstructions' => !empty($enhanced['instructions']),
        ]);

        return [
            'text' => $enhanced['text'],
            'instructions' => $enhanced['instructions'] ?? '',
        ];

    } catch (\Exception $e) {
        Log::warning('VoiceoverService: Failed to apply emotional direction', [
            'emotion' => $emotion,
            'error' => $e->getMessage(),
        ]);
        return ['text' => $text, 'instructions' => ''];
    }
}
```

Add use statement at top of file if not present:
```php
use Modules\AppVideoWizard\Services\VoicePromptBuilderService;
```
  </action>
  <verify>
Check the method exists by searching the file for "enhanceTextWithVoiceDirection".
  </verify>
  <done>Helper method added for emotional text enhancement.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate enhancement into generateSceneVoiceover</name>
  <files>modules/AppVideoWizard/app/Services/VoiceoverService.php</files>
  <action>
Modify generateSceneVoiceover to use emotional enhancement when emotion is provided.

1. Find the generateSceneVoiceover method (around line 75)

2. Add emotion parameter extraction from options:
```php
$emotion = $options['emotion'] ?? null;
```

3. Before the TTS generation calls (before line ~98), add enhancement:
```php
// Apply emotional direction if specified (VOC-11)
$instructions = '';
if ($emotion) {
    $provider = $forceProvider ?? $this->getProvider();
    $enhanced = $this->enhanceTextWithVoiceDirection($narration, $emotion, $provider);
    $narration = $enhanced['text'];
    $instructions = $enhanced['instructions'];
}
```

4. For OpenAI provider (in generateWithOpenAI), pass instructions if available.
   Find the AI::process call and update to include instructions when present:
```php
$speechOptions = ['voice' => $voice];
if (!empty($options['instructions'])) {
    $speechOptions['instructions'] = $options['instructions'];
}
$result = AI::process($narration, 'speech', $speechOptions, $teamId);
```

5. Pass instructions through options:
```php
return $this->generateWithOpenAI($project, $scene, $narration, $voice, $speed, $teamId, array_merge($options, ['instructions' => $instructions]));
```

IMPORTANT: Preserve all existing functionality. This is additive only.
  </action>
  <verify>
Create test in tinker:
```php
$service = app(\Modules\AppVideoWizard\Services\VoiceoverService::class);
// Check method signature accepts emotion option
$r = new ReflectionMethod($service, 'generateSceneVoiceover');
// Should not throw
```
  </verify>
  <done>generateSceneVoiceover integrates VoicePromptBuilderService for emotional TTS.</done>
</task>

<task type="auto">
  <name>Task 3: Update generateSegmentedAudio to use enhancement</name>
  <files>modules/AppVideoWizard/app/Services/VoiceoverService.php</files>
  <action>
The generateSegmentedAudio method (around line 909) already processes segments.
Update it to use VoicePromptBuilderService for each segment with emotion.

1. Find the foreach loop that processes segments (around line 950)

2. Inside the try block, before the AI::process call, add enhancement:
```php
// Apply emotional direction if segment has emotion (VOC-11)
$textToSpeak = $segment->text;
$instructions = '';

if (!empty($segment->emotion)) {
    $provider = $this->getProvider();
    $enhanced = $this->enhanceTextWithVoiceDirection($segment->text, $segment->emotion, $provider);
    $textToSpeak = $enhanced['text'];
    $instructions = $enhanced['instructions'];
}

// Use enhanced text for TTS
$speechOptions = ['voice' => $voice];
if (!empty($instructions)) {
    $speechOptions['instructions'] = $instructions;
}
$audioResult = AI::process($textToSpeak, 'speech', $speechOptions, $teamId);
```

3. Replace the existing AI::process call to use $textToSpeak and $speechOptions.

4. Add to segment result for debugging:
```php
'emotionApplied' => !empty($segment->emotion),
'emotion' => $segment->emotion,
```

IMPORTANT: Preserve existing segment processing logic. Only add enhancement step.
  </action>
  <verify>
Search file for "enhanceTextWithVoiceDirection" - should appear in generateSegmentedAudio.
  </verify>
  <done>generateSegmentedAudio applies emotional direction to each segment.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. In wizard, create a scene with emotional dialogue
2. Generate voiceover for a segment with emotion (e.g., fear)
3. Check Laravel logs for "Applied emotional direction" entry
4. For ElevenLabs: verify text contains emotion tags like [fearful]
5. For OpenAI: verify instructions parameter is passed to API
</verification>

<success_criteria>
- [ ] enhanceTextWithVoiceDirection helper method exists
- [ ] generateSceneVoiceover accepts emotion option
- [ ] generateSegmentedAudio enhances each segment with emotion
- [ ] OpenAI gets instructions parameter when emotion present
- [ ] ElevenLabs gets inline tags in text
- [ ] No regression in basic TTS (without emotion)
</success_criteria>

<output>
After completion, create `.planning/phases/28-voice-production-excellence/28-04-SUMMARY.md`
</output>
