---
phase: 05-emotional-arc-system
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - modules/AppVideoWizard/app/Livewire/VideoWizard.php
  - modules/AppVideoWizard/resources/views/livewire/video-wizard.blade.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Emotional arc data is exposed as Livewire property"
    - "Shot cards display intensity indicators"
    - "Climax shots are visually marked"
    - "Arc template can be selected"
  artifacts:
    - path: "modules/AppVideoWizard/app/Livewire/VideoWizard.php"
      provides: "Arc data exposure for UI"
      contains: "emotionalArcData"
  key_links:
    - from: "VideoWizard.php"
      to: "blade template"
      via: "emotionalArcData property"
      pattern: "$emotionalArcData"
---

<objective>
Expose emotional arc data to UI with intensity indicators on shots.

**PROBLEM:** Emotional arc data exists but is invisible:
- No UI visualization of intensity curve
- No indicators showing shot intensity
- No climax markers on storyboard
- No template selection

Purpose: Make emotional arc visible and controllable in the UI.

Output: Intensity indicators on shots, climax markers, template selector.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@modules/AppVideoWizard/app/Livewire/VideoWizard.php
@modules/AppVideoWizard/resources/views/livewire/video-wizard.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add emotional arc Livewire properties</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add properties to expose emotional arc data:

Find the properties section and add:

```php
/**
 * PHASE 5: Emotional arc data for visualization.
 */
public array $emotionalArcData = [
    'values' => [],
    'smoothed' => [],
    'template' => 'hollywood',
    'climax' => null,
];

/**
 * PHASE 5: Selected arc template.
 */
public string $arcTemplate = 'hollywood';

/**
 * PHASE 5: Available arc templates.
 */
public array $arcTemplates = [
    'hollywood' => 'Hollywood (Standard)',
    'action' => 'Action (Multiple Peaks)',
    'drama' => 'Drama (Slow Build)',
    'thriller' => 'Thriller (Sustained Tension)',
    'comedy' => 'Comedy (Lighter Tone)',
    'documentary' => 'Documentary (Flat)',
];
```

WHY: Properties expose arc data for blade template access.
  </action>
  <verify>
    - `$emotionalArcData` property exists
    - `$arcTemplate` property exists
    - `$arcTemplates` property exists with options
    - No PHP syntax errors
  </verify>
  <done>Emotional arc Livewire properties added</done>
</task>

<task type="auto">
  <name>Task 2: Add method to update arc data</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add method to compute and store arc data:

```php
/**
 * PHASE 5: Update emotional arc data from current storyboard.
 */
public function updateEmotionalArcData(): void
{
    if (empty($this->scenes)) {
        $this->emotionalArcData = [
            'values' => [],
            'smoothed' => [],
            'template' => $this->arcTemplate,
            'climax' => null,
            'stats' => [],
        ];
        return;
    }

    // Collect all shot intensities
    $allIntensities = [];
    $shotToSceneMap = [];

    foreach ($this->scenes as $sceneIndex => $scene) {
        $shots = $scene['shots'] ?? [];
        foreach ($shots as $shotIndex => $shot) {
            $key = "{$sceneIndex}_{$shotIndex}";
            $allIntensities[$key] = $shot['emotionalIntensity'] ?? 0.5;
            $shotToSceneMap[$key] = [
                'scene' => $sceneIndex,
                'shot' => $shotIndex,
            ];
        }
    }

    if (empty($allIntensities)) {
        return;
    }

    // Get NarrativeMomentService
    $momentService = app(NarrativeMomentService::class);

    // Convert to indexed array for processing
    $rawValues = array_values($allIntensities);

    // Get processed curve
    $curveData = $momentService->getProcessedIntensityCurve(
        array_map(fn($i) => ['intensity' => $i], $rawValues),
        $this->arcTemplate
    );

    // Detect climax
    $moments = array_map(fn($i) => ['intensity' => $i], $rawValues);
    $climaxData = $momentService->detectClimaxFromContent($moments);

    // Map climax index back to scene/shot
    $keys = array_keys($allIntensities);
    $climaxKey = $keys[$climaxData['index']] ?? null;
    $climaxLocation = $climaxKey ? $shotToSceneMap[$climaxKey] : null;

    $this->emotionalArcData = [
        'values' => $curveData['raw'],
        'smoothed' => $curveData['processed'],
        'template' => $this->arcTemplate,
        'climax' => [
            'index' => $climaxData['index'],
            'scene' => $climaxLocation['scene'] ?? null,
            'shot' => $climaxLocation['shot'] ?? null,
            'confidence' => $climaxData['confidence'],
            'method' => $climaxData['method'],
        ],
        'stats' => $curveData['stats'],
        'peaks' => $climaxData['peaks'] ?? [],
    ];

    Log::debug('VideoWizard: Emotional arc data updated', [
        'shot_count' => count($allIntensities),
        'template' => $this->arcTemplate,
        'climax_scene' => $climaxLocation['scene'] ?? 'none',
    ]);
}

/**
 * PHASE 5: Change arc template and recalculate.
 */
public function setArcTemplate(string $template): void
{
    if (isset($this->arcTemplates[$template])) {
        $this->arcTemplate = $template;
        $this->updateEmotionalArcData();

        // Reapply template to shots
        $this->applyArcTemplateToShots();
    }
}

/**
 * PHASE 5: Apply arc template intensities to existing shots.
 */
protected function applyArcTemplateToShots(): void
{
    if (empty($this->emotionalArcData['smoothed'])) {
        return;
    }

    $smoothed = $this->emotionalArcData['smoothed'];
    $index = 0;

    foreach ($this->scenes as $sceneIndex => &$scene) {
        $shots = $scene['shots'] ?? [];
        foreach ($shots as $shotIndex => &$shot) {
            if (isset($smoothed[$index])) {
                $shot['emotionalIntensity'] = $smoothed[$index];

                // Mark climax
                $shot['isClimax'] = (
                    $this->emotionalArcData['climax']['scene'] === $sceneIndex &&
                    $this->emotionalArcData['climax']['shot'] === $shotIndex
                );
            }
            $index++;
        }
        $scene['shots'] = $shots;
    }
}
```

WHY: Methods compute arc data and allow template switching.
  </action>
  <verify>
    - `updateEmotionalArcData()` method exists
    - `setArcTemplate()` method exists
    - `applyArcTemplateToShots()` method exists
    - Climax location tracked by scene/shot
    - No PHP syntax errors
  </verify>
  <done>Method to update arc data added</done>
</task>

<task type="auto">
  <name>Task 3: Call arc update when storyboard changes</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add calls to `updateEmotionalArcData()` at appropriate places:

1. After scene generation completes (find where scenes are populated):
```php
// After generating/updating scenes
$this->updateEmotionalArcData();
```

2. After batch image generation completes:
```php
// In batch generation completion handler
$this->updateEmotionalArcData();
```

3. In the `mount()` or `hydrate()` method if scenes already exist:
```php
// In mount() or when loading existing project
if (!empty($this->scenes)) {
    $this->updateEmotionalArcData();
}
```

4. Add a listener for manual refresh:
```php
#[On('refresh-emotional-arc')]
public function refreshEmotionalArc(): void
{
    $this->updateEmotionalArcData();
}
```

WHY: Arc data stays synchronized with storyboard state.
  </action>
  <verify>
    - `updateEmotionalArcData()` called after scene generation
    - Called on mount/hydrate if scenes exist
    - Listener exists for manual refresh
    - No PHP syntax errors
  </verify>
  <done>Arc update calls integrated</done>
</task>

<task type="auto">
  <name>Task 4: Add intensity indicators to shot display data</name>
  <files>modules/AppVideoWizard/app/Livewire/VideoWizard.php</files>
  <action>
Add a method to get intensity display data for a shot:

```php
/**
 * PHASE 5: Get intensity display data for a shot.
 *
 * @param float $intensity Shot intensity (0-1)
 * @param bool $isClimax Whether this is the climax shot
 * @return array Display data for UI
 */
public function getIntensityDisplayData(float $intensity, bool $isClimax = false): array
{
    // Color gradient from blue (low) to red (high)
    $colors = [
        'low' => '#3B82F6',      // Blue - calm
        'medium' => '#F59E0B',   // Amber - moderate
        'high' => '#EF4444',     // Red - intense
        'climax' => '#8B5CF6',   // Purple - peak
    ];

    // Determine color
    if ($isClimax) {
        $color = $colors['climax'];
        $label = 'CLIMAX';
    } elseif ($intensity >= 0.7) {
        $color = $colors['high'];
        $label = 'High';
    } elseif ($intensity >= 0.4) {
        $color = $colors['medium'];
        $label = 'Medium';
    } else {
        $color = $colors['low'];
        $label = 'Low';
    }

    // Percentage for width
    $percentage = round($intensity * 100);

    return [
        'value' => round($intensity, 2),
        'percentage' => $percentage,
        'color' => $color,
        'label' => $label,
        'isClimax' => $isClimax,
        'barWidth' => "{$percentage}%",
    ];
}

/**
 * PHASE 5: Get arc summary for display.
 */
public function getArcSummary(): array
{
    if (empty($this->emotionalArcData['values'])) {
        return [
            'hasData' => false,
        ];
    }

    $stats = $this->emotionalArcData['stats'] ?? [];
    $climax = $this->emotionalArcData['climax'] ?? [];

    return [
        'hasData' => true,
        'template' => $this->arcTemplates[$this->arcTemplate] ?? $this->arcTemplate,
        'shotCount' => count($this->emotionalArcData['values']),
        'avgIntensity' => round(($stats['average'] ?? 0.5) * 100) . '%',
        'peakIntensity' => round(($stats['max'] ?? 0.5) * 100) . '%',
        'climaxScene' => isset($climax['scene']) ? 'Scene ' . ($climax['scene'] + 1) : 'Not detected',
        'climaxConfidence' => round(($climax['confidence'] ?? 0) * 100) . '%',
    ];
}
```

WHY: Display methods format arc data for UI consumption.
  </action>
  <verify>
    - `getIntensityDisplayData()` method exists
    - Returns color, label, percentage, isClimax
    - `getArcSummary()` method exists
    - Returns template, counts, climax info
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
  </verify>
  <done>Intensity indicators for shot display added</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Livewire/VideoWizard.php`
2. Grep for new properties and methods:
   - `grep -n "emotionalArcData" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
   - `grep -n "updateEmotionalArcData" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
   - `grep -n "getIntensityDisplayData" modules/AppVideoWizard/app/Livewire/VideoWizard.php`
</verification>

<success_criteria>
- emotionalArcData property exposed for blade
- Arc template selector property available
- updateEmotionalArcData syncs with storyboard
- getIntensityDisplayData provides UI formatting
- Climax location tracked by scene/shot
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/05-emotional-arc-system/05-03-SUMMARY.md`
</output>
