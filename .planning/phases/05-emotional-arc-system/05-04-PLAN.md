---
phase: 05-emotional-arc-system
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - modules/AppVideoWizard/app/Services/DynamicShotEngine.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Shot types adapt based on smoothed intensity"
    - "Climax shots get tighter framing automatically"
    - "Template affects shot type distribution"
    - "Intensity thresholds are configurable"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/DynamicShotEngine.php"
      provides: "Enhanced emotion-to-shot mapping"
      contains: "applySmoothedIntensityToShots"
  key_links:
    - from: "DynamicShotEngine.php"
      to: "shot types"
      via: "smoothed intensity mapping"
      pattern: "intensityToShotType"
---

<objective>
Enhance emotion-to-shot mapping with smoothed intensities and climax awareness.

**PROBLEM:** Current shot type selection doesn't use enhanced arc:
- Uses raw intensity, not smoothed
- No special handling for detected climax
- No template-aware shot distribution
- Thresholds are hardcoded

Purpose: Shot types should follow the smoothed emotional arc with climax emphasis.

Output: Shot types adapt to smoothed curve with climax getting tighter framing.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@modules/AppVideoWizard/app/Services/DynamicShotEngine.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configurable intensity thresholds</name>
  <files>modules/AppVideoWizard/app/Services/DynamicShotEngine.php</files>
  <action>
Add configurable thresholds for shot type selection:

```php
/**
 * PHASE 5: Intensity thresholds for shot type selection.
 * Can be customized per template or globally.
 */
protected array $intensityThresholds = [
    'extreme-close-up' => 0.85,  // XCU for peak moments
    'close-up' => 0.70,          // CU for high emotion
    'medium-close' => 0.55,      // MCU for engagement
    'medium' => 0.40,            // Standard shots
    'wide' => 0.25,              // Context shots
    'establishing' => 0.0,       // Opening/scale shots
];

/**
 * PHASE 5: Template-specific threshold adjustments.
 */
protected array $templateThresholdAdjustments = [
    'action' => [
        'close-up' => -0.05,      // More close-ups in action
        'extreme-close-up' => -0.05,
    ],
    'drama' => [
        'close-up' => -0.10,      // Even more close-ups in drama
        'medium' => -0.05,
    ],
    'comedy' => [
        'wide' => -0.10,          // More wide shots in comedy
        'close-up' => +0.10,      // Fewer close-ups
    ],
    'documentary' => [
        'medium' => -0.15,        // More medium shots
        'close-up' => +0.15,      // Fewer close-ups
    ],
];

/**
 * PHASE 5: Get adjusted thresholds for a template.
 *
 * @param string $template Arc template name
 * @return array Adjusted intensity thresholds
 */
protected function getAdjustedThresholds(string $template = 'hollywood'): array
{
    $thresholds = $this->intensityThresholds;
    $adjustments = $this->templateThresholdAdjustments[$template] ?? [];

    foreach ($adjustments as $shotType => $adjustment) {
        if (isset($thresholds[$shotType])) {
            $thresholds[$shotType] = max(0, min(1, $thresholds[$shotType] + $adjustment));
        }
    }

    return $thresholds;
}
```

WHY: Configurable thresholds allow template-specific shot distributions.
  </action>
  <verify>
    - `$intensityThresholds` property exists
    - `$templateThresholdAdjustments` property exists
    - `getAdjustedThresholds()` method exists
    - Returns adjusted thresholds per template
    - No PHP syntax errors
  </verify>
  <done>Configurable intensity thresholds added</done>
</task>

<task type="auto">
  <name>Task 2: Add climax-aware shot type selection</name>
  <files>modules/AppVideoWizard/app/Services/DynamicShotEngine.php</files>
  <action>
Add method for climax-aware shot type selection:

```php
/**
 * PHASE 5: Select shot type with climax awareness.
 *
 * @param float $intensity Shot intensity (0-1)
 * @param bool $isClimax Whether this is the detected climax
 * @param string $template Arc template being used
 * @return string Selected shot type
 */
public function selectShotTypeWithClimaxAwareness(
    float $intensity,
    bool $isClimax = false,
    string $template = 'hollywood'
): string {
    // Climax shots get special treatment
    if ($isClimax) {
        // Always use tight framing for climax
        return $intensity >= 0.9 ? 'extreme-close-up' : 'close-up';
    }

    // Get template-adjusted thresholds
    $thresholds = $this->getAdjustedThresholds($template);

    // Select based on intensity
    foreach ($thresholds as $shotType => $threshold) {
        if ($intensity >= $threshold) {
            return $shotType;
        }
    }

    return 'establishing';
}

/**
 * PHASE 5: Get camera movement suggestion based on intensity.
 *
 * @param float $intensity Shot intensity
 * @param bool $isClimax Is climax shot
 * @return string|null Suggested camera movement
 */
public function getCameraMovementForIntensity(float $intensity, bool $isClimax = false): ?string
{
    if ($isClimax) {
        return 'push-in'; // Dramatic push toward climax
    }

    if ($intensity >= 0.75) {
        return 'slow-push'; // Building tension
    }

    if ($intensity <= 0.3) {
        return 'static'; // Calm moments are still
    }

    // Mid-intensity can have subtle movement
    return rand(0, 1) ? 'slight-drift' : 'static';
}
```

WHY: Climax awareness ensures peak moments get maximum visual impact.
  </action>
  <verify>
    - `selectShotTypeWithClimaxAwareness()` method exists
    - Climax shots get tight framing (close-up or XCU)
    - Uses template-adjusted thresholds
    - `getCameraMovementForIntensity()` method exists
    - No PHP syntax errors
  </verify>
  <done>Climax-aware shot type selection added</done>
</task>

<task type="auto">
  <name>Task 3: Add smoothed intensity application method</name>
  <files>modules/AppVideoWizard/app/Services/DynamicShotEngine.php</files>
  <action>
Add method to apply smoothed intensities to shot array:

```php
/**
 * PHASE 5: Apply smoothed intensity curve to shots.
 * Updates shot types based on processed emotional arc.
 *
 * @param array $shots Array of shots to process
 * @param array $smoothedIntensities Smoothed intensity values
 * @param int|null $climaxIndex Index of detected climax
 * @param string $template Arc template
 * @return array Shots with updated types and intensities
 */
public function applySmoothedIntensityToShots(
    array $shots,
    array $smoothedIntensities,
    ?int $climaxIndex = null,
    string $template = 'hollywood'
): array {
    $count = count($shots);

    foreach ($shots as $i => &$shot) {
        $intensity = $smoothedIntensities[$i] ?? $shot['emotionalIntensity'] ?? 0.5;
        $isClimax = ($climaxIndex !== null && $i === $climaxIndex);

        // Update intensity
        $shot['emotionalIntensity'] = $intensity;
        $shot['rawIntensity'] = $shot['rawIntensity'] ?? $intensity;
        $shot['isClimax'] = $isClimax;

        // Update shot type based on intensity (unless it's a special type)
        $specialTypes = ['establishing', 'two-shot', 'reaction'];
        $currentType = $shot['type'] ?? 'medium';

        if (!in_array($currentType, $specialTypes)) {
            $newType = $this->selectShotTypeWithClimaxAwareness($intensity, $isClimax, $template);

            // Only upgrade (tighter) shot types, never downgrade during climax approach
            if ($this->getShotTypeTightness($newType) >= $this->getShotTypeTightness($currentType) || !$isClimax) {
                $shot['type'] = $newType;
            }
        }

        // Add camera movement suggestion
        $shot['suggestedMovement'] = $this->getCameraMovementForIntensity($intensity, $isClimax);

        // Add intensity metadata
        $shot['intensityMeta'] = [
            'template' => $template,
            'smoothed' => true,
            'climaxProximity' => $climaxIndex !== null
                ? 1 - abs($i - $climaxIndex) / max(1, $count)
                : 0,
        ];
    }

    Log::debug('DynamicShotEngine: Applied smoothed intensity to shots', [
        'shot_count' => $count,
        'climax_index' => $climaxIndex,
        'template' => $template,
    ]);

    return $shots;
}

/**
 * PHASE 5: Get tightness ranking for shot type (higher = tighter).
 */
protected function getShotTypeTightness(string $shotType): int
{
    $rankings = [
        'establishing' => 0,
        'wide' => 1,
        'two-shot' => 2,
        'medium' => 3,
        'medium-close' => 4,
        'close-up' => 5,
        'extreme-close-up' => 6,
    ];

    return $rankings[$shotType] ?? 3;
}
```

WHY: This is the main integration point for smoothed arc data.
  </action>
  <verify>
    - `applySmoothedIntensityToShots()` method exists (public)
    - Updates shot types based on smoothed intensity
    - Respects climax index with tight framing
    - Adds suggestedMovement
    - Adds intensityMeta
    - `getShotTypeTightness()` method exists
    - No PHP syntax errors
  </verify>
  <done>Smoothed intensity application method added</done>
</task>

<task type="auto">
  <name>Task 4: Integrate into generateHollywoodShotSequence</name>
  <files>modules/AppVideoWizard/app/Services/DynamicShotEngine.php</files>
  <action>
Update `generateHollywoodShotSequence()` to use the enhanced arc processing:

Find where emotional arc is processed and update:

```php
// PHASE 5: Enhanced emotional arc processing
if (!empty($emotionalArc)) {
    // Check if we have smoothed data
    $smoothedValues = $emotionalArc['smoothed'] ?? $emotionalArc['values'] ?? $emotionalArc;
    $template = $emotionalArc['template'] ?? 'hollywood';

    // Get climax data if available
    $climaxIndex = null;
    if (isset($emotionalArc['climax']['index'])) {
        $climaxIndex = $emotionalArc['climax']['index'];
    } elseif (isset($context['climaxData']['index'])) {
        $climaxIndex = $context['climaxData']['index'];
    }

    // Apply smoothed intensities with climax awareness
    $shots = $this->applySmoothedIntensityToShots(
        $shots,
        is_array($smoothedValues) ? $smoothedValues : [],
        $climaxIndex,
        $template
    );

    Log::info('DynamicShotEngine: Applied enhanced emotional arc', [
        'template' => $template,
        'climax_index' => $climaxIndex,
        'smoothed' => isset($emotionalArc['smoothed']),
    ]);
}
```

Also update the return value to include arc metadata:

```php
return [
    'shots' => $shots,
    'patterns' => $appliedPatterns,
    'emotionalArc' => [
        'applied' => !empty($emotionalArc),
        'template' => $emotionalArc['template'] ?? 'hollywood',
        'climaxIndex' => $climaxIndex ?? null,
    ],
];
```

WHY: This connects the enhanced arc to Hollywood shot sequence generation.
  </action>
  <verify>
    - `generateHollywoodShotSequence()` uses `applySmoothedIntensityToShots()`
    - Extracts smoothed values from arc data
    - Respects climax index
    - Returns arc metadata in result
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/DynamicShotEngine.php`
  </verify>
  <done>Enhanced arc processing integrated into generateHollywoodShotSequence</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Services/DynamicShotEngine.php`
2. Grep for new methods:
   - `grep -n "applySmoothedIntensityToShots" modules/AppVideoWizard/app/Services/DynamicShotEngine.php`
   - `grep -n "selectShotTypeWithClimaxAwareness" modules/AppVideoWizard/app/Services/DynamicShotEngine.php`
   - `grep -n "intensityThresholds" modules/AppVideoWizard/app/Services/DynamicShotEngine.php`
</verification>

<success_criteria>
- Intensity thresholds are configurable per template
- Climax shots get tight framing (close-up/XCU)
- Camera movement suggestions based on intensity
- Smoothed intensity applied to shot array
- generateHollywoodShotSequence uses enhanced processing
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/05-emotional-arc-system/05-04-SUMMARY.md`
</output>
