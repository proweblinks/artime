---
phase: 05-emotional-arc-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/AppVideoWizard/app/Services/NarrativeMomentService.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Intensity curve is smoothed to avoid jarring transitions"
    - "Curve interpolation fills gaps between moments"
    - "Arc shape can be Hollywood standard or custom"
    - "Smoothed intensities stored in shot data"
  artifacts:
    - path: "modules/AppVideoWizard/app/Services/NarrativeMomentService.php"
      provides: "Intensity curve smoothing and shaping"
      contains: "smoothIntensityCurve"
  key_links:
    - from: "NarrativeMomentService.php"
      to: "intensity array"
      via: "curve smoothing algorithm"
      pattern: "smoothedIntensity"
---

<objective>
Add intensity curve smoothing and interpolation for cinematic flow.

**PROBLEM:** Current intensity values are raw and jagged:
- Abrupt jumps between moments
- No smoothing for visual transitions
- No interpolation for missing values
- Single arc shape (no customization)

Purpose: Create smooth, cinematic intensity curves that map to professional pacing.

Output: Smoothed intensity curves with configurable arc shapes.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@modules/AppVideoWizard/app/Services/NarrativeMomentService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add intensity smoothing algorithm</name>
  <files>modules/AppVideoWizard/app/Services/NarrativeMomentService.php</files>
  <action>
Add a smoothing algorithm using moving average:

```php
/**
 * PHASE 5: Smooth an intensity curve using weighted moving average.
 * Prevents jarring transitions between consecutive moments.
 *
 * @param array $intensities Raw intensity values
 * @param int $windowSize Number of neighbors to consider (odd number)
 * @return array Smoothed intensity values
 */
protected function smoothIntensityCurve(array $intensities, int $windowSize = 3): array
{
    $count = count($intensities);
    if ($count <= 2) {
        return $intensities;
    }

    // Ensure odd window size
    $windowSize = max(3, $windowSize | 1);
    $halfWindow = intdiv($windowSize, 2);

    $smoothed = [];

    foreach ($intensities as $i => $value) {
        $sum = 0;
        $weightSum = 0;

        for ($j = -$halfWindow; $j <= $halfWindow; $j++) {
            $idx = $i + $j;
            if ($idx >= 0 && $idx < $count) {
                // Weight decreases with distance from center
                $weight = 1 / (1 + abs($j));
                $sum += $intensities[$idx] * $weight;
                $weightSum += $weight;
            }
        }

        $smoothed[$i] = $weightSum > 0 ? $sum / $weightSum : $value;
    }

    // Preserve climax peaks - don't smooth them down
    foreach ($intensities as $i => $original) {
        if ($original >= 0.8 && $smoothed[$i] < $original - 0.1) {
            // Restore peak that was smoothed too much
            $smoothed[$i] = max($smoothed[$i], $original - 0.05);
        }
    }

    return $smoothed;
}

/**
 * PHASE 5: Apply exponential smoothing for more gradual transitions.
 *
 * @param array $intensities Raw intensity values
 * @param float $alpha Smoothing factor (0-1, lower = smoother)
 * @return array Exponentially smoothed values
 */
protected function exponentialSmooth(array $intensities, float $alpha = 0.3): array
{
    $count = count($intensities);
    if ($count <= 1) {
        return $intensities;
    }

    $smoothed = [$intensities[0]];

    for ($i = 1; $i < $count; $i++) {
        $smoothed[$i] = $alpha * $intensities[$i] + (1 - $alpha) * $smoothed[$i - 1];
    }

    return $smoothed;
}
```

WHY: Smoothing prevents jarring visual transitions in cinematography.
  </action>
  <verify>
    - `smoothIntensityCurve()` method exists
    - Uses weighted moving average
    - Preserves peaks (doesn't smooth climax down)
    - `exponentialSmooth()` method exists
    - No PHP syntax errors
  </verify>
  <done>Intensity smoothing algorithm added</done>
</task>

<task type="auto">
  <name>Task 2: Add arc shape templates</name>
  <files>modules/AppVideoWizard/app/Services/NarrativeMomentService.php</files>
  <action>
Add predefined arc shape templates:

```php
/**
 * PHASE 5: Arc shape templates for different narrative styles.
 * Values represent target intensities at 0%, 25%, 50%, 75%, 100% of narrative.
 */
protected const ARC_TEMPLATES = [
    // Standard Hollywood three-act structure
    'hollywood' => [
        0.0 => 0.35,   // Setup
        0.25 => 0.50,  // Rising action
        0.50 => 0.65,  // Midpoint turn
        0.70 => 0.85,  // Climax
        0.85 => 0.60,  // Falling action
        1.0 => 0.40,   // Resolution
    ],

    // Action-heavy with multiple peaks
    'action' => [
        0.0 => 0.40,
        0.20 => 0.70,  // Early action
        0.40 => 0.55,  // Brief lull
        0.60 => 0.80,  // Major setpiece
        0.80 => 0.90,  // Climax
        1.0 => 0.45,
    ],

    // Drama with slow build
    'drama' => [
        0.0 => 0.25,
        0.30 => 0.35,
        0.50 => 0.50,
        0.75 => 0.80,  // Late climax
        0.90 => 0.70,
        1.0 => 0.35,
    ],

    // Thriller with sustained tension
    'thriller' => [
        0.0 => 0.50,
        0.25 => 0.65,
        0.50 => 0.70,
        0.75 => 0.85,
        0.90 => 0.80,  // Sustained high
        1.0 => 0.50,
    ],

    // Comedy with lighter tone
    'comedy' => [
        0.0 => 0.40,
        0.25 => 0.50,
        0.50 => 0.55,
        0.70 => 0.65,
        0.85 => 0.55,
        1.0 => 0.50,
    ],

    // Flat/documentary style
    'documentary' => [
        0.0 => 0.45,
        0.25 => 0.50,
        0.50 => 0.55,
        0.75 => 0.55,
        1.0 => 0.50,
    ],
];

/**
 * PHASE 5: Get target intensity at a given position from arc template.
 *
 * @param string $template Arc template name
 * @param float $position Position in narrative (0-1)
 * @return float Target intensity at position
 */
protected function getArcTargetIntensity(string $template, float $position): float
{
    $arcPoints = self::ARC_TEMPLATES[$template] ?? self::ARC_TEMPLATES['hollywood'];

    $positions = array_keys($arcPoints);
    $intensities = array_values($arcPoints);

    // Find surrounding points for interpolation
    $prevPos = 0.0;
    $prevInt = $intensities[0];
    $nextPos = 1.0;
    $nextInt = end($intensities);

    foreach ($positions as $i => $pos) {
        if ($pos <= $position) {
            $prevPos = $pos;
            $prevInt = $intensities[$i];
        }
        if ($pos >= $position) {
            $nextPos = $pos;
            $nextInt = $intensities[$i];
            break;
        }
    }

    // Linear interpolation between points
    if ($nextPos === $prevPos) {
        return $prevInt;
    }

    $t = ($position - $prevPos) / ($nextPos - $prevPos);
    return $prevInt + $t * ($nextInt - $prevInt);
}
```

WHY: Arc templates provide genre-appropriate pacing.
  </action>
  <verify>
    - ARC_TEMPLATES constant exists with multiple templates
    - Includes hollywood, action, drama, thriller, comedy, documentary
    - `getArcTargetIntensity()` method exists
    - Interpolates between arc points
    - No PHP syntax errors
  </verify>
  <done>Arc shape templates added</done>
</task>

<task type="auto">
  <name>Task 3: Add curve blending with templates</name>
  <files>modules/AppVideoWizard/app/Services/NarrativeMomentService.php</files>
  <action>
Add method to blend actual intensities with arc templates:

```php
/**
 * PHASE 5: Blend actual intensities with arc template.
 * Combines content-derived intensity with template shape.
 *
 * @param array $intensities Actual intensity values
 * @param string $template Arc template name
 * @param float $blendWeight How much template influences (0=none, 1=full)
 * @return array Blended intensity values
 */
public function blendWithArcTemplate(
    array $intensities,
    string $template = 'hollywood',
    float $blendWeight = 0.5
): array {
    $count = count($intensities);
    if ($count === 0) {
        return [];
    }

    $blended = [];

    foreach ($intensities as $i => $actual) {
        $position = $i / max(1, $count - 1);
        $target = $this->getArcTargetIntensity($template, $position);

        // Blend actual with template
        $blended[$i] = ($actual * (1 - $blendWeight)) + ($target * $blendWeight);
    }

    return $blended;
}

/**
 * PHASE 5: Get smoothed and shaped intensity curve.
 * Main entry point for intensity curve processing.
 *
 * @param array $moments Narrative moments with intensity
 * @param string $template Arc template to apply
 * @param bool $smooth Whether to apply smoothing
 * @return array Processed intensity values with metadata
 */
public function getProcessedIntensityCurve(
    array $moments,
    string $template = 'hollywood',
    bool $smooth = true
): array {
    // Extract raw intensities
    $raw = array_map(fn($m) => $m['intensity'] ?? 0.5, $moments);

    // Blend with template
    $blended = $this->blendWithArcTemplate($raw, $template, 0.4);

    // Apply smoothing
    $processed = $smooth ? $this->smoothIntensityCurve($blended) : $blended;

    // Calculate curve statistics
    $stats = [
        'min' => min($processed),
        'max' => max($processed),
        'average' => array_sum($processed) / max(1, count($processed)),
        'range' => max($processed) - min($processed),
        'template' => $template,
        'smoothed' => $smooth,
    ];

    return [
        'raw' => $raw,
        'processed' => $processed,
        'stats' => $stats,
    ];
}
```

WHY: Blending preserves content emotion while ensuring cinematic pacing.
  </action>
  <verify>
    - `blendWithArcTemplate()` method exists
    - `getProcessedIntensityCurve()` method exists (public)
    - Returns raw, processed, and stats
    - Blend weight controls template influence
    - No PHP syntax errors
  </verify>
  <done>Curve blending with templates added</done>
</task>

<task type="auto">
  <name>Task 4: Integrate smoothing into extractEmotionalArc</name>
  <files>modules/AppVideoWizard/app/Services/NarrativeMomentService.php</files>
  <action>
Update the existing `extractEmotionalArc()` method to use smoothing:

Find the existing method and enhance it:

```php
/**
 * PHASE 5: Extract and process emotional arc from moments.
 * Enhanced with smoothing and template blending.
 *
 * @param array $moments Array of narrative moments
 * @param string $template Arc template to apply (default: hollywood)
 * @param bool $smooth Whether to smooth the curve
 * @return array Processed emotional arc with raw and smoothed values
 */
public function extractEmotionalArc(
    array $moments,
    string $template = 'hollywood',
    bool $smooth = true
): array {
    if (empty($moments)) {
        return [
            'values' => [],
            'smoothed' => [],
            'template' => $template,
        ];
    }

    // Get processed curve
    $curveData = $this->getProcessedIntensityCurve($moments, $template, $smooth);

    // Log arc extraction
    Log::debug('NarrativeMomentService: Extracted emotional arc', [
        'moment_count' => count($moments),
        'template' => $template,
        'smoothed' => $smooth,
        'stats' => $curveData['stats'],
    ]);

    return [
        'values' => $curveData['raw'],
        'smoothed' => $curveData['processed'],
        'template' => $template,
        'stats' => $curveData['stats'],
    ];
}
```

Also update any places that store intensity on shots to use smoothed values:

```php
// When applying arc to shots, use smoothed intensity
$arcData = $this->extractEmotionalArc($moments);
$smoothedIntensities = $arcData['smoothed'] ?? $arcData['values'];

foreach ($shots as $i => &$shot) {
    $shot['emotionalIntensity'] = $smoothedIntensities[$i] ?? 0.5;
    $shot['rawIntensity'] = $arcData['values'][$i] ?? 0.5;
}
```

WHY: Smoothed intensities create more professional shot progression.
  </action>
  <verify>
    - `extractEmotionalArc()` now returns raw and smoothed values
    - Accepts template parameter
    - Logs extraction with stats
    - Smoothed values used for shot intensity
    - No PHP syntax errors: `php -l modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
  </verify>
  <done>Smoothing integrated into extractEmotionalArc</done>
</task>

</tasks>

<verification>
1. PHP syntax check: `php -l modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
2. Grep for new methods:
   - `grep -n "smoothIntensityCurve" modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
   - `grep -n "ARC_TEMPLATES" modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
   - `grep -n "blendWithArcTemplate" modules/AppVideoWizard/app/Services/NarrativeMomentService.php`
</verification>

<success_criteria>
- Intensity smoothing prevents jarring transitions
- Arc templates provide genre-specific shapes
- Blending combines content intensity with template
- extractEmotionalArc returns smoothed values
- Stats provide curve metadata
- PHP syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/05-emotional-arc-system/05-02-SUMMARY.md`
</output>
